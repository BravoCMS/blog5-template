/* !
 * jQuery LinkyArticle 2.0 (03.10.2014)
 * Copyright (c) 2014, Vadym Danyliuk < vdlinky@gmail.com >
 * Released under the MIT license
 */
 
(function ($) {
  // Функція копіювання контенту
  function sav_html (element){
    var elem =$('#storag').html(element.clone()).html();
    return elem;
  }

  var myScriptDetails = $('script[src*="linkyarticle"]')[0].src;

  var filePath = myScriptDetails.split('/');
  filePath = filePath.slice(0, filePath.length-2);
  filePath = filePath.join('/') + '/';
  
  // Обєкт для класів
  var classesObject;

  $(document).ready(function () {
    // Блок копіювання контенту
    $('body').append('<div id="storag" style="display:none"></div>');
    // Загрузити вікно вибору сітки
    $.ajax({
      url: filePath +'templates/grid_modal.html',
      async: false,
      dataType: 'html',
      success: function (data) {
        $('body').append(data);
      }
    });

    // Загрузити вікно вибору id
    $.ajax({
      url: filePath+'templates/id_modal.html',
      async: false,
      dataType: 'html',
      success: function (data) {
        $('body').append(data);
      }
    });

    // Загрузити вікно вибору class-у
    $.ajax({
      url: filePath+'templates/class_modal.html',
      async: false,
      dataType: 'html',
      success: function (data) {
        $('body').append(data);
        $('#classModal').on('show.bs.modal', function (e) {
          $(this).find('.modal-body').css({
            'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
          });
        });
      }
    });

    // Загрузити вікно вибору тега
    $.ajax({
      url: filePath+'templates/tags_modal.html',
      async: false,
      dataType: 'html',
      success: function (data) {
        $('body').append(data);
      }
    });



    // ТЕГ ТОВАРІВ -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-goods').on('click', function () {
      $('#tagGoodsModal').remove();
      // Загрузити вікно тега товарів
      $.ajax({
        url: filePath+'templates/tag-goods.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagGoodsModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataCount = tagBlock.attr('data-count'),
            dataOffered = tagBlock.attr('data-offered'),
            dataForHomepage = tagBlock.attr('data-forHomepage'),
            dataSort = $.trim(tagBlock.attr('data-sort')),
            dataDiscount = tagBlock.attr('data-discount'),
            dataRubricType = tagBlock.attr('data-rubricType'),
            dataRubric = tagBlock.attr('data-rubric'),
            dataCategory = tagBlock.attr('data-category'),
            dataCatalogArticle = tagBlock.attr('data-catalogArticle');

        $('#tag-goods-count').val(dataCount);
        if (dataOffered) {
          $('#tag-goods').prop("checked", false);
          $('#tag-goods_offered').prop("checked", true);
        }
        if (dataForHomepage) {
          $('#tag-goods').prop("checked", false);
          $('#tag-goods_for_homepage').prop("checked", true);
        }
        if (dataSort) {
          switch (dataSort) {
            case 'sort=last':
              $('#tag-goods_sort').prop("checked", false);
              $('#tag-goods_sort_last').prop("checked", true);
              break;
            case 'sort=first':
              $('#tag-goods_sort').prop("checked", false);
              $('#tag-goods_sort_first').prop("checked", true);
              break;
            case 'sort=cheap':
              $('#tag-goods_sort').prop("checked", false);
              $('#tag-goods_sort_cheap').prop("checked", true);
              break;
            case 'sort=expensive':
              $('#tag-goods_sort').prop("checked", false);
              $('#tag-goods_sort_expensive').prop("checked", true);
              break;
          }
        }
        dataDiscount ? $('#tag-goods_discount').prop("checked", true) : '';
        dataRubricType ? $('.js-select2-rubric-type-test').append(dataRubricType) : '';
        dataRubric ? $('.js-select2-rubric-test').append(dataRubric) : '';
        dataCategory ? $('.js-select2-category-test').append(dataCategory) : '';
        dataCatalogArticle ? $('.js-select2-catalog-article-test').append(dataCatalogArticle) : '';
        $('#tagGoodsModal option').prop("selected", true);
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagGoodsModal').data('activeBlock', activeBlock);
      $('#tagGoodsModal').data('Article', Article);

      $('#tagGoodsModal').modal('show');

      $(".js-select2-rubric-type-test").select2({
          ajax: {
              url: "/admin/ajax/article2_rubric_types.htm",
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data
                  };
              },
              cache: true
          }
      });

      $(".js-select2-rubric-type-test").on('change', function () {
          var value = $(this).find('option:selected').val();
          catalogArticlesQueryParams.rubricType = value;
          catalogArticlesQueryParams.rubric = 0;
          catalogArticlesQueryParams.category = 0;

          $(".js-select2-rubric-test").select2({
              ajax: {
                  url: "/admin/ajax/article2_rubrics.htm",
                  data: function (params) {
                      params.q = params.term;
                      params.rubricType = value;
                      return params;
                  },
                  dataType: 'jsonp',
                  delay: 250,
                  processResults: function (data) {
                      return {
                          results: data
                      };
                  },
                  cache: true
              }
          });
      });

      $(".js-select2-rubric-test").on('change', function () {
          var value = $(this).find('option:selected').val();
          catalogArticlesQueryParams.rubric = value;
          catalogArticlesQueryParams.category = 0;

          $(".js-select2-category-test").select2({
              ajax: {
                  url: "/admin/ajax/article2_categories.htm",
                  data: function (params) {
                      params.q = params.term;
                      params.rubric = value;
                      return params;
                  },
                  dataType: 'jsonp',
                  delay: 250,
                  processResults: function (data) {
                      return {
                          results: data
                      };
                  },
                  cache: true
              }
          });
      });

      $(".js-select2-category-test").on('change', function () {
          var value = $(this).find('option:selected').val();
          catalogArticlesQueryParams.category = value;
      });

      var catalogArticlesQueryParams = {};
      $(".js-select2-catalog-article-test").select2({
          ajax: {
              url: "/admin/ajax/article2_catalog_articles.htm",
              data: function (params) {
                  params.q = params.term;
                  params = $.extend(params, catalogArticlesQueryParams);
                  return params;
              },
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data.items,
                      pagination: {
                          more: data.pagination.page < data.pagination.total
                      }
                  };
              },
              cache: true
          }
      });

      // Вставка тега товарів
      $('.create-tagGoods-btn').on('click', function() {
        var activeBlock = $('#tagGoodsModal').data('activeBlock'),
            Article = $('#tagGoodsModal').data('Article');

        // Параметри
        var count = $('#tag-goods-count').val() ? $('#tag-goods-count').val() : '0',
            offered = $('#tag-goods_offered').prop('checked') ? $('#tag-goods_offered').val() : '',
            forHomepage = $('#tag-goods_for_homepage').prop('checked') ? $('#tag-goods_for_homepage').val() : '',
            last = $('#tag-goods_sort_last').prop('checked') ? $('#tag-goods_sort_last').val() : '',
            first = $('#tag-goods_sort_first').prop('checked') ? $('#tag-goods_sort_first').val() : '',
            cheap = $('#tag-goods_sort_cheap').prop('checked') ? $('#tag-goods_sort_cheap').val() : '',
            expensive = $('#tag-goods_sort_expensive').prop('checked') ? $('#tag-goods_sort_expensive').val() : '',
            sort = last || first || cheap || expensive ? 'sort='+last+first+cheap+expensive : '',
            discount = $('#tag-goods_discount').prop('checked') ? $('#tag-goods_discount').val() : '',
            rubricType = $('.js-select2-rubric-type-test option:selected').length ? sav_html($(".js-select2-rubric-type-test option:selected")) : '',
            rubricTypeId = $('.js-select2-rubric-type-test option:selected').length ? 'rubric_type_id='+$(".js-select2-rubric-type-test option:selected").val() : '',
            rubric = $('.js-select2-rubric-test option:selected').length ? sav_html($('.js-select2-rubric-test option:selected')) : '',
            rubricId = $('.js-select2-rubric-test option:selected').length ? 'rubric_id='+$('.js-select2-rubric-test option:selected').val() : '',
            category = $('.js-select2-category-test option:selected').length ? sav_html($('.js-select2-category-test option:selected')) : '',
            categoryId = $('.js-select2-category-test option:selected').length ? 'category_id='+$('.js-select2-category-test option:selected').val() : '',
            catalogArticle = [],
            catalogArticleId = [];

        if ($('.js-select2-catalog-article-test option:selected').length) {
          $('.js-select2-catalog-article-test option:selected').each(function () {
            catalogArticle.push(sav_html($(this)));
            catalogArticleId.push($(this).val());
          });
        }

        var id = catalogArticleId.length > 0 ? 'id='+catalogArticleId.join(',') : '';

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-goods-block" '+
          'data-count="'+count+'" '+
          'data-offered="'+offered+'" '+
          'data-forHomepage="'+forHomepage+'" '+
          'data-sort="'+sort+'" '+
          'data-discount="'+discount+'" '+
          'data-rubricType=\''+rubricType+'\' '+
          'data-rubric=\''+rubric+'\' '+
          'data-category=\''+category+'\' '+
          'data-catalogArticle=\''+catalogArticle.join('\n')+'\' '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-goods__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">Товары</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<goods '+id+' '+rubricTypeId+' '+rubricId+' '+categoryId+' '+sort+' '+discount+' '+offered+' '+forHomepage+'>'+count+'</goods>'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-goods__button--setting').on('click', function () {
          $('.tag-goods').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagGoodsModal').removeData('Article');
        $('#tagGoodsModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ БРЕНДІВ -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-brands').on('click', function () {
      $('#tagBrandsModal').remove();
      // Загрузити вікно тега брендів
      $.ajax({
        url: filePath+'templates/tag-brands.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagBrandsModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataCount = tagBlock.attr('data-count'),
            dataPhoto = tagBlock.attr('data-photo'),
            dataDesc = tagBlock.attr('data-desc'),
            dataNoname = tagBlock.attr('data-noname');

        $('#tag-brands-count').val(dataCount);
        
        dataPhoto ? $('#tag-brands_photo').prop("checked", true) : '';
        dataDesc ? $('#tag-brands_desc').prop("checked", true) : '';
        dataNoname ? $('#tag-brands_noname').prop("checked", true) : '';
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagBrandsModal').data('activeBlock', activeBlock);
      $('#tagBrandsModal').data('Article', Article);

      $('#tagBrandsModal').modal('show');

      // Вставка тега брендів
      $('.create-tagBrands-btn').on('click', function() {
        var activeBlock = $('#tagBrandsModal').data('activeBlock'),
            Article = $('#tagBrandsModal').data('Article');

        // Параметри
        var count = $('#tag-brands-count').val() ? $('#tag-brands-count').val() : '0',
            photo = $('#tag-brands_photo').prop('checked') ? $('#tag-brands_photo').val() : '',
            desc = $('#tag-brands_desc').prop('checked') ? $('#tag-brands_desc').val() : '',
            noname = $('#tag-brands_noname').prop('checked') ? $('#tag-brands_noname').val() : '';

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-brands-block" '+
          'data-count="'+count+'" '+
          'data-photo="'+photo+'" '+
          'data-desc="'+desc+'" '+
          'data-noname="'+noname+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-brands__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">Бренды</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<brands '+photo+' '+desc+' '+noname+'>'+count+'</brands>'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-brands__button--setting').on('click', function () {
          $('.tag-brands').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagBrandsModal').removeData('Article');
        $('#tagBrandsModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ ФОТОАЛЬБОМІВ -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-albums').on('click', function () {
      $('#tagAlbumsModal').remove();
      // Загрузити вікно тега фотоальбомів
      $.ajax({
        url: filePath + 'templates/tag-albums.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagAlbumsModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataCount = tagBlock.attr('data-count'),
            dataPage = tagBlock.attr('data-page'),
            dataAlbum = tagBlock.attr('data-album'),
            dataTitle = $.trim(tagBlock.attr('data-title')),
            dataPhoto = tagBlock.attr('data-photo'),
            dataLargePhoto = tagBlock.attr('data-largePhoto'),
            dataDesc = tagBlock.attr('data-desc'),
            dataDescFull = tagBlock.attr('data-descFull'),
            dataDescExtra = tagBlock.attr('data-descExtra'),
            dataPhotoCount = tagBlock.attr('data-photoCount'),
            dataRandom = tagBlock.attr('data-random'),
            dataDateAdded = tagBlock.attr('data-dateAdded'),
            dataDateUpdated = tagBlock.attr('data-dateUpdated'),
            dataGalleryCount = tagBlock.attr('data-galleryCount'),
            dataGalleryPreview = tagBlock.attr('data-galleryPreview'),
            dataGalleryFullsize = tagBlock.attr('data-galleryFullsize'),
            dataPhotoDesc = tagBlock.attr('data-photo-desc');

        $('#tag-albums-count').val(dataCount);
        dataPage ? $('#tagAlbumsModal .js-select2-pages-test2').append(dataPage) : '';
        dataAlbum ? $('#tagAlbumsModal .js-select2-albums-test2').append(dataAlbum) : '';
        dataTitle ? $('#tag-albums_title').prop("checked", true) : '';
        dataPhoto ? $('#tag-albums_photo').prop("checked", true) : '';
        dataLargePhoto ? $('#tag-albums_large_photo').prop("checked", true) : '';
        dataDesc ? $('#tag-albums_desc').prop("checked", true) : '';
        dataDescFull ? $('#tag-albums_desc_full').prop("checked", true) : '';
        dataDescExtra ? $('#tag-albums_desc_extra').prop("checked", true) : '';
        dataPhotoCount ? $('#tag-albums_photo_count').prop("checked", true) : '';
        dataRandom ? $('#tag-albums_random').prop("checked", true) : '';
        dataDateAdded ? $('#tag-albums_date_added').prop("checked", true) : '';
        dataDateUpdated ? $('#tag-albums_date_updated').prop("checked", true) : '';
        $('#tag-albums-gallery-count').val(dataGalleryCount);
        if (dataGalleryPreview) {
          $('#tag-albums_gallery_fullsize').prop("checked", false);
          $('#tag-albums_gallery_preview').prop("checked", true);
        }
        if (dataGalleryFullsize) {
          $('#tag-albums_gallery_preview').prop("checked", false);
          $('#tag-albums_gallery_fullsize').prop("checked", true);
        }
        dataPhotoDesc ? $('#tag-albums_photo-desc').prop("checked", true) : '';
        $('#tagAlbumsModal option').prop("selected", true);
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagAlbumsModal').data('activeBlock', activeBlock);
      $('#tagAlbumsModal').data('Article', Article);

      $('#tagAlbumsModal').modal('show');

      $(".js-select2-pages-test2").select2({
          ajax: {
              url: "/admin/ajax/article2_pages.htm",
              data: function (params) {
                  params.q = params.term;
                  params.modules = [
                      'photo'
                  ];
                  return params;
              },
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data
                  };
              },
              cache: true
          }
      });

      $(".js-select2-albums-test2").select2({
          ajax: {
              url: "/admin/ajax/article2_photos_albums.htm",
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data.items,
                      pagination: {
                          more: data.pagination.page < data.pagination.total
                      }
                  };
              },
              cache: true
          }
      });

      // Вставка тега фотоальбомів
      $('.create-tagAlbums-btn').on('click', function() {
        var activeBlock = $('#tagAlbumsModal').data('activeBlock'),
            Article = $('#tagAlbumsModal').data('Article');

        // Параметри
        var count = $('#tag-albums-count').val() ? $('#tag-albums-count').val() : '0',
            page = [],
            pageId = [],
            album = [],
            albumId = [];
            title = $('#tag-albums_title').prop('checked') ? $('#tag-albums_title').val() : '',
            photo = $('#tag-albums_photo').prop('checked') ? $('#tag-albums_photo').val() : '',
            largePhoto = $('#tag-albums_large_photo').prop('checked') ? $('#tag-albums_large_photo').val() : '',
            desc = $('#tag-albums_desc').prop('checked') ? $('#tag-albums_desc').val() : '',
            descFull = $('#tag-albums_desc_full').prop('checked') ? $('#tag-albums_desc_full').val() : '',
            descExtra = $('#tag-albums_desc_extra').prop('checked') ? $('#tag-albums_desc_extra').val() : '',
            photoCount = $('#tag-albums_photo_count').prop('checked') ? $('#tag-albums_photo_count').val() : '',
            random = $('#tag-albums_random').prop('checked') ? $('#tag-albums_random').val() : '',
            dateAdded = $('#tag-albums_date_added').prop('checked') ? $('#tag-albums_date_added').val() : '',
            dateUpdated = $('#tag-albums_date_updated').prop('checked') ? $('#tag-albums_date_updated').val() : '',
            galleryCount = $('#tag-albums-gallery-count').val() ? $('#tag-albums-gallery-count').val() : '0',
            galleryPreview = $('#tag-albums_gallery_preview').prop('checked') ? $('#tag-albums_gallery_preview').val() : '',
            galleryFullsize = $('#tag-albums_gallery_fullsize').prop('checked') ? $('#tag-albums_gallery_fullsize').val() : '',
            photoDesc =  $('#tag-albums_photo-desc').prop("checked") ? $('#tag-albums_photo-desc').val() : '';

        if ($('.js-select2-pages-test2 option:selected').length) {
          $('.js-select2-pages-test2 option:selected').each(function () {
            page.push(sav_html($(this)));
            pageId.push($(this).val());
          });
        }

        var page_id = pageId.length > 0 ? 'page='+pageId.join(',') : '';

        if ($('.js-select2-albums-test2 option:selected').length) {
          $('.js-select2-albums-test2 option:selected').each(function () {
            album.push(sav_html($(this)));
            albumId.push($(this).val());
          });
        }

        var album_id = albumId.length > 0 ? 'album='+albumId.join(',') : '';

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-albums-block" '+
          'data-count="'+count+'" '+
          'data-page=\''+page.join('\n')+'\' '+
          'data-album=\''+album.join('\n')+'\' '+
          'data-title="'+title+'" '+
          'data-photo="'+photo+'" '+
          'data-largePhoto="'+largePhoto+'" '+
          'data-desc="'+desc+'" '+
          'data-descFull="'+descFull+'" '+
          'data-descExtra="'+descExtra+'" '+
          'data-photoCount="'+photoCount+'" '+
          'data-random="'+random+'" '+
          'data-dateAdded="'+dateAdded+'" '+
          'data-dateUpdated="'+dateUpdated+'" '+
          'data-galleryCount="'+galleryCount+'" '+
          'data-galleryPreview="'+galleryPreview+'" '+
          'data-galleryFullsize="'+galleryFullsize+'" '+
          'data-photo-desc="'+photoDesc+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-albums__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">Фотоальбомы</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<albums '+page_id+' '+album_id+' '+title+' '+photo+' '+largePhoto+' '+desc+' '+descFull+' '+descExtra+' '+photoCount+' '+random+' '+dateAdded+' '+dateUpdated+' gallery='+galleryCount+' '+galleryPreview+' '+galleryFullsize+' '+photoDesc+'>'+count+'</albums>'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-albums__button--setting').on('click', function () {
          $('.tag-albums').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagAlbumsModal').removeData('Article');
        $('#tagAlbumsModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ ФОТОГАЛЕРЕЇ -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-photo').on('click', function () {
      $('#tagPhotoModal').remove();
      // Загрузити вікно тега фотогалереї
      $.ajax({
        url: filePath+'templates/tag-photo.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagPhotoModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataCount = tagBlock.attr('data-count'),
            dataAlbum = tagBlock.attr('data-album'),
            dataTitle = tagBlock.attr('data-title'),
            dataDesc = $.trim(tagBlock.attr('data-desc')),
            dataDescription = tagBlock.attr('data-description'),
            dataLarge = tagBlock.attr('data-large'),
            dataUrl = tagBlock.attr('data-url'),
            dataRandom = tagBlock.attr('data-random'),
            dataPhotoDesc = tagBlock.attr('data-photo-desc');

        $('#tag-photo-count').val(dataCount);
        dataAlbum ? $('#tagPhotoModal .js-select2-albums-photo').append(dataAlbum) : '';
        dataTitle ? $('#tag-photo_title').prop("checked", true) : '';
        dataDesc ? $('#tag-photo_desc').prop("checked", true) : '';
        dataDescription ? $('#tag-photo_description').prop("checked", true) : '';
        dataLarge ? $('#tag-photo_large').prop("checked", true) : '';
        dataUrl ? $('#tag-photo_url').prop("checked", true) : '';
        dataRandom ? $('#tag-photo_random').prop("checked", true) : '';
        dataPhotoDesc ? $('#tag-photo_photo-desc').prop("checked", true) : '';
        $('#tagPhotoModal option').prop("selected", true);
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagPhotoModal').data('activeBlock', activeBlock);
      $('#tagPhotoModal').data('Article', Article);

      $('#tagPhotoModal').modal('show');

      $(".js-select2-albums-photo").select2({
          ajax: {
              url: "/admin/ajax/article2_photos_albums.htm",
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data.items,
                      pagination: {
                          more: data.pagination.page < data.pagination.total
                      }
                  };
              },
              cache: true
          }
      });

      // Вставка тега фотогалереї
      $('.create-tagPhoto-btn').on('click', function() {
        var activeBlock = $('#tagPhotoModal').data('activeBlock'),
            Article = $('#tagPhotoModal').data('Article');

        // Параметри
        var count = $('#tag-photo-count').val() ? $('#tag-photo-count').val() : '0',
            album = [],
            albumId = [],
            title = $('#tag-photo_title').prop('checked') ? $('#tag-photo_title').val() : '',
            desc = $('#tag-photo_desc').prop('checked') ? $('#tag-photo_desc').val() : '',
            description = $('#tag-photo_description').prop('checked') ? $('#tag-photo_description').val() : '',
            large = $('#tag-photo_large').prop('checked') ? $('#tag-photo_large').val() : '',
            url = $('#tag-photo_url').prop('checked') ? $('#tag-photo_url').val() : '',
            random = $('#tag-photo_random').prop('checked') ? $('#tag-photo_random').val() : '',
            photoDesc =  $('#tag-photo_photo-desc').prop("checked") ? $('#tag-photo_photo-desc').val() : '';

        if ($('.js-select2-albums-photo option:selected').length) {
          $('.js-select2-albums-photo option:selected').each(function () {
            album.push(sav_html($(this)));
            albumId.push($(this).val());
          });
        }

        var album_id = albumId.length > 0 ? 'album='+albumId.join(',') : '';

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-photo-block" '+
          'data-count="'+count+'" '+
          'data-album=\''+album.join('\n')+'\' '+
          'data-title="'+title+'" '+
          'data-desc="'+desc+'" '+
          'data-description="'+description+'" '+
          'data-large="'+large+'" '+
          'data-url="'+url+'" '+
          'data-random="'+random+'" '+
          'data-photo-desc="'+photoDesc+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-photo__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">Фотогалерея</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<photo '+album_id+' '+title+' '+desc+' '+description+' '+large+' '+url+' '+random+' '+photoDesc+'>'+count+'</photo>'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-photo__button--setting').on('click', function () {
          $('.tag-photo').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagPhotoModal').removeData('Article');
        $('#tagPhotoModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ НОВИН -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-last_news').on('click', function () {
      $('#tagLastNewsModal').remove();
      // Загрузити вікно тега новин
      $.ajax({
        url: filePath+'templates/tag-last_news.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagLastNewsModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataCount = tagBlock.attr('data-count'),
            dataFrom = tagBlock.attr('data-from'),
            dataByAuthor = tagBlock.attr('data-byAuthor'),
            dataId = tagBlock.attr('data-id'),
            dataPhoto = $.trim(tagBlock.attr('data-photo')),
            dataLargePhoto = tagBlock.attr('data-largePhoto'),
            dataText = tagBlock.attr('data-text'),
            dataFullText = tagBlock.attr('data-fullText'),
            dataNodate = tagBlock.attr('data-nodate'),
            dataNolink = tagBlock.attr('data-nolink'),
            dataNomore = tagBlock.attr('data-nomore'),
            dataTop = tagBlock.attr('data-top'),
            dataNotop = tagBlock.attr('data-notop'),
            dataSource = tagBlock.attr('data-source'),
            dataAuthor = tagBlock.attr('data-author'),
            dataAuthorPhotoPreview = tagBlock.attr('data-authorPhotoPreview'),
            dataAuthorPhotoOriginal = tagBlock.attr('data-authorPhotoOriginal'),
            dataReviewCount = tagBlock.attr('data-reviewCount'),
            dataReviewTrunc = tagBlock.attr('data-reviewTrunc'),
            dataReviewAuthor = tagBlock.attr('data-reviewAuthor'),
            dataReviewDate = tagBlock.attr('data-reviewDate'),
            dataOrder = tagBlock.attr('data-order'),
            dataViews = tagBlock.attr('data-views'),
            dataVotes = tagBlock.attr('data-votes'),
            dataVotesRatingLocal = tagBlock.attr('data-votesRatingLocal'),
            dataVotesRatingGlobal = tagBlock.attr('data-votesRatingGlobal'),
            dataTotalCount = tagBlock.attr('data-totalCount');

        $('#tag-last-news-count').val(dataCount);
        dataFrom ? $('.js-select2-pages-last-news').append(dataFrom) : '';
        dataByAuthor ? $('.js-select2-authors-last-news').append(dataByAuthor) : '';
        dataId ? $('.js-select2-last-news').append(dataId) : '';
        if (dataPhoto) {
          $('#tag-last-news_nophoto').prop("checked", false);
          $('#tag-last-news_photo').prop("checked", true);
        }
        if (dataLargePhoto) {
          $('#tag-last-news_nophoto').prop("checked", false);
          $('#tag-last-news_large_photo').prop("checked", true);
        }
        $('#tag-text-count').val(dataText);
        dataFullText ? $('#tag-last-news_full_text').prop("checked", true) : '';
        dataNodate ? $('#tag-last-news_nodate').prop("checked", true) : '';
        dataNolink ? $('#tag-last-news_nolink').prop("checked", true) : '';
        dataNomore ? $('#tag-last-news_nomore').prop("checked", true) : '';
        if (dataTop) {
          $('#tag-last-news_all').prop("checked", false);
          $('#tag-last-news_top').prop("checked", true);
        }
        if (dataNotop) {
          $('#tag-last-news_all').prop("checked", false);
          $('#tag-last-news_notop').prop("checked", true);
        }
        dataSource ? $('#tag-last-news_source').prop("checked", true) : '';
        dataAuthor ? $('#tag-last-news_author').prop("checked", true) : '';
        if (dataAuthorPhotoPreview) {
          $('#tag-last-news_author-nophoto').prop("checked", false);
          $('#tag-last-news_author-photo-preview').prop("checked", true);
        }
        if (dataAuthorPhotoOriginal) {
          $('#tag-last-news_author-nophoto').prop("checked", false);
          $('#tag-last-news_author-photo-original').prop("checked", true);
        }
        $('#tag-last-news-review_count').val(dataReviewCount);
        $('#tag-last-news-review_trunc').val(dataReviewTrunc);
        dataReviewAuthor ? $('#tag-last-news_review_author').prop("checked", true) : '';
        dataReviewDate ? $('#tag-last-news_review_date').prop("checked", true) : '';
        dataViews ? $('#tag-last-news_views').prop("checked", true) : '';
        dataVotes ? $('#tag-last-news_votes').prop("checked", true) : '';
        dataVotesRatingLocal ? $('#tag-last-news_votes_rating_local').prop("checked", true) : '';
        dataVotesRatingGlobal ? $('#tag-last-news_votes_rating_global').prop("checked", true) : '';
        dataTotalCount ? $('#tag-last-news_total_count').prop("checked", true) : '';
        if (dataOrder != 'date_desc') {
          $('#tag-last-news-order option').prop("selected", false);
          $('#tag-last-news-order option[value="'+dataOrder+'"]').prop("selected", true);
        }
        $('#tagLastNewsModal select:not(#tag-last-news-order) option').prop("selected", true);
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagLastNewsModal').data('activeBlock', activeBlock);
      $('#tagLastNewsModal').data('Article', Article);

      $('#tagLastNewsModal').modal('show');

      $(".js-select2-pages-last-news").select2({
          ajax: {
              url: "/admin/ajax/article2_pages.htm",
              data: function (params) {
                  params.q = params.term;
                  params.modules = [
                      'public'
                  ];
                  return params;
              },
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data
                  };
              },
              cache: true
          }
      });

      $(".js-select2-authors-last-news").select2({
          ajax: {
              url: "/admin/ajax/article2_articles_authors.htm",
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data.items,
                      pagination: {
                          more: data.pagination.page < data.pagination.total
                      }
                  };
              },
              cache: true
          }
      });

      $(".js-select2-last-news").select2({
          ajax: {
              url: "/admin/ajax/article2_articles.htm",
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data.items,
                      pagination: {
                          more: data.pagination.page < data.pagination.total
                      }
                  };
              },
              cache: true
          }
      });

      // Вставка тега новин
      $('.create-tagLastNews-btn').on('click', function() {
        var activeBlock = $('#tagLastNewsModal').data('activeBlock'),
            Article = $('#tagLastNewsModal').data('Article');

        // Параметри
        var count = $('#tag-last-news-count').val() ? $('#tag-last-news-count').val() : '0',
            from = [],
            fromId = [],
            byAuthor = [],
            byAuthorId = [],
            id = [],
            idId = [],
            photo = $('#tag-last-news_photo').prop('checked') ? $('#tag-last-news_photo').val() : '',
            largePhoto = $('#tag-last-news_large_photo').prop('checked') ? $('#tag-last-news_large_photo').val() : '',
            text = $('#tag-text-count').val() ? $('#tag-text-count').val() : '0',
            fullText = $('#tag-last-news_full_text').prop('checked') ? $('#tag-last-news_full_text').val() : '',
            nodate = $('#tag-last-news_nodate').prop('checked') ? $('#tag-last-news_nodate').val() : '',
            nolink = $('#tag-last-news_nolink').prop('checked') ? $('#tag-last-news_nolink').val() : '',
            nomore = $('#tag-last-news_nomore').prop('checked') ? $('#tag-last-news_nomore').val() : '',
            top = $('#tag-last-news_top').prop('checked') ? $('#tag-last-news_top').val() : '',
            notop = $('#tag-last-news_notop').prop('checked') ? $('#tag-last-news_notop').val() : '',
            source = $('#tag-last-news_source').prop('checked') ? $('#tag-last-news_source').val() : '',
            author = $('#tag-last-news_author').prop('checked') ? $('#tag-last-news_author').val() : '',
            authorPhotoPreview = $('#tag-last-news_author-photo-preview').prop('checked') ? $('#tag-last-news_author-photo-preview').val() : '',
            authorPhotoOriginal = $('#tag-last-news_author-photo-original').prop('checked') ? $('#tag-last-news_author-photo-original').val() : '',
            reviewCount = $('#tag-last-news-review_count').val() ? $('#tag-last-news-review_count').val() : '0',
            reviewTrunc = $('#tag-last-news-review_trunc').val() ? $('#tag-last-news-review_trunc').val() : '0',
            reviewAuthor = $('#tag-last-news_review_author').prop('checked') ? $('#tag-last-news_review_author').val() : '',
            reviewDate = $('#tag-last-news_review_date').prop('checked') ? $('#tag-last-news_review_date').val() : '',
            order = $('#tag-last-news-order option:selected').val(),
            views = $('#tag-last-news_views').prop('checked') ? $('#tag-last-news_views').val() : '',
            votes = $('#tag-last-news_votes').prop('checked') ? $('#tag-last-news_votes').val() : '',
            votesRatingLocal = $('#tag-last-news_votes_rating_local').prop('checked') ? $('#tag-last-news_votes_rating_local').val() : '',
            votesRatingGlobal = $('#tag-last-news_votes_rating_global').prop('checked') ? $('#tag-last-news_votes_rating_global').val() : '';
            totalCount = $('#tag-last-news_total_count').prop('checked') ? $('#tag-last-news_total_count').val() : '';

        if ($('.js-select2-pages-last-news option:selected').length) {
          $('.js-select2-pages-last-news option:selected').each(function () {
            from.push(sav_html($(this)));
            fromId.push($(this).val());
          });
        }
        var from_id = fromId.length > 0 ? 'from='+fromId.join(',') : '';

        if ($('.js-select2-authors-last-news option:selected').length) {
          $('.js-select2-authors-last-news option:selected').each(function () {
            byAuthor.push(sav_html($(this)));
            byAuthorId.push($(this).val());
          });
        }
        var byAuthor_id = byAuthorId.length > 0 ? 'by_author='+byAuthorId.join(',') : '';

        if ($('.js-select2-last-news option:selected').length) {
          $('.js-select2-last-news option:selected').each(function () {
            id.push(sav_html($(this)));
            idId.push($(this).val());
          });
        }
        var id_id = idId.length > 0 ? 'id='+idId.join(',') : '';

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-last_news-block" '+
          'data-count="'+count+'" '+
          'data-from=\''+from+'\' '+
          'data-byAuthor=\''+byAuthor+'\' '+
          'data-id=\''+id+'\' '+
          'data-photo="'+photo+'" '+
          'data-largePhoto="'+largePhoto+'" '+
          'data-text="'+text+'" '+
          'data-fullText="'+fullText+'" '+
          'data-nodate="'+nodate+'" '+
          'data-nolink="'+nolink+'" '+
          'data-nomore="'+nomore+'" '+
          'data-top="'+top+'" '+
          'data-notop="'+notop+'" '+
          'data-source="'+source+'" '+
          'data-author="'+author+'" '+
          'data-authorPphotoPreview="'+authorPhotoPreview+'" '+
          'data-authorPhotoOriginal="'+authorPhotoOriginal+'" '+
          'data-reviewCount="'+reviewCount+'" '+
          'data-reviewTrunc="'+reviewTrunc+'" '+
          'data-reviewAuthor="'+reviewAuthor+'" '+
          'data-reviewDate="'+reviewDate+'" '+
          'data-order="'+order+'" '+
          'data-views="'+views+'" '+
          'data-votes="'+votes+'" '+
          'data-votesRatingLocal="'+votesRatingLocal+'" '+
          'data-votesRatingGlobal="'+votesRatingGlobal+'" '+
          'data-totalCount="'+totalCount+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-last_news__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">Статьи</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<last_news '+from_id+' '+byAuthor_id+' '+id_id+' '+photo+' '+largePhoto+' text='+text+' '+fullText+' '+nodate+' '+nolink+' '+nomore+' '+top+' '+notop+' '+source+' '+author+' '+authorPhotoPreview+' '+authorPhotoOriginal+' review_count='+reviewCount+' review_trunc='+reviewTrunc+' '+reviewAuthor+' '+reviewDate+' '+'order_by='+order+' '+views+' '+votes+' '+votesRatingLocal+' '+votesRatingGlobal+' '+totalCount+'>'+count+'</last_news>'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-last_news__button--setting').on('click', function () {
          $('.tag-last_news').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagLastNewsModal').removeData('Article');
        $('#tagLastNewsModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ ВІДГУКІВ -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-reviews').on('click', function () {
      $('#tagReviewsModal').remove();
      // Загрузити вікно тега відгуків
      $.ajax({
        url: filePath+'templates/tag-reviews.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagReviewsModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataCount = tagBlock.attr('data-count'),
            dataType1 = tagBlock.attr('data-type1'),
            dataType4 = tagBlock.attr('data-type4'),
            dataType2 = tagBlock.attr('data-type2'),
            dataGoods = tagBlock.attr('data-goods'),
            dataArticles = tagBlock.attr('data-articles'),
            dataPages = tagBlock.attr('data-pages'),
            dataElementNoName = tagBlock.attr('data-elementNoName'),
            dataElementNoPhoto = tagBlock.attr('data-elementNoPhoto'),
            dataText = tagBlock.attr('data-text'),
            dataTrunc = tagBlock.attr('data-trunc'),
            dataAuthor = tagBlock.attr('data-author'),
            dataDate = tagBlock.attr('data-date'),
            dataStars = tagBlock.attr('data-stars'),
            dataDepth = tagBlock.attr('data-depth');

        $('#tag-reviews-count').val(dataCount);
        if (dataType1) {
          $('#tag-reviews-type-1').prop("checked", true);
          $('#tag-reviews-type-4').prop("checked", false);
          $('#tag-reviews-type-2').prop("checked", false);
          $('.rew-type-1').removeClass('hide');
          $('.rew-type-4').addClass('hide');
          $('.rew-type-2').addClass('hide');
        }
        if (dataType4) {
          $('#tag-reviews-type-1').prop("checked", false);
          $('#tag-reviews-type-4').prop("checked", true);
          $('#tag-reviews-type-2').prop("checked", false);
          $('.rew-type-1').addClass('hide');
          $('.rew-type-4').removeClass('hide');
          $('.rew-type-2').addClass('hide');
        }
        if (dataType2) {
          $('#tag-reviews-type-1').prop("checked", false);
          $('#tag-reviews-type-4').prop("checked", false);
          $('#tag-reviews-type-2').prop("checked", true);
          $('.rew-type-1').addClass('hide');
          $('.rew-type-4').addClass('hide');
          $('.rew-type-2').removeClass('hide');
        }
        dataGoods ? $('.js-select2-catalog-article-reviews').append(dataGoods) : '';
        dataArticles ? $('.js-select2-article-reviews').append(dataArticles) : '';
        dataPages ? $('.js-select2-pages-reviews').append(dataPages) : '';
        dataElementNoName ? $('#tag-reviews_element_no_name').prop("checked", true) : '';
        dataElementNoPhoto ? $('#tag-reviews_element_no_photo').prop("checked", true) : '';
        dataText ? $('#tag-reviews_text').prop("checked", true) : '';
        $('#tag-reviews-trunc').val(dataTrunc);
        dataAuthor ? $('#tag-reviews_author').prop("checked", true) : '';
        dataDate ? $('#tag-reviews_date').prop("checked", true) : '';
        dataStars ? $('#tag-reviews_stars').prop("checked", true) : '';
        $('#tag-reviews-depth').val(dataDepth);
        $('#tagReviewsModal option').prop("selected", true);
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagReviewsModal').data('activeBlock', activeBlock);
      $('#tagReviewsModal').data('Article', Article);

      $('#tagReviewsModal').modal('show');

      var catalogArticlesQueryParams = {};
      $(".js-select2-catalog-article-reviews").select2({
          ajax: {
              url: "/admin/ajax/article2_catalog_articles.htm",
              data: function (params) {
                  params.q = params.term;
                  params = $.extend(params, catalogArticlesQueryParams);
                  return params;
              },
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data.items,
                      pagination: {
                          more: data.pagination.page < data.pagination.total
                      }
                  };
              },
              cache: true
          }
      });

      $(".js-select2-article-reviews").select2({
          ajax: {
              url: "/admin/ajax/article2_articles.htm",
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data.items,
                      pagination: {
                          more: data.pagination.page < data.pagination.total
                      }
                  };
              },
              cache: true
          }
      });

      $(".js-select2-pages-reviews").select2({
          ajax: {
              url: "/admin/ajax/article2_pages.htm",
              data: function (params) {
                  params.q = params.term;
                  params.modules = [
                      'text'
                  ];
                  return params;
              },
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data
                  };
              },
              cache: true
          }
      });

      $('#tag-reviews-type-1').on('change', function () {
        if ($(this).prop("checked")) {
          $('.rew-type-4').addClass('hide');
          $('.rew-type-2').addClass('hide');
          $('.rew-type-1').removeClass('hide');
        }
      });
      $('#tag-reviews-type-4').on('change', function () {
        if ($(this).prop("checked")) {
          $('.rew-type-1').addClass('hide');
          $('.rew-type-2').addClass('hide');
          $('.rew-type-4').removeClass('hide');
        }
      });
      $('#tag-reviews-type-2').on('change', function () {
        if ($(this).prop("checked")) {
          $('.rew-type-1').addClass('hide');
          $('.rew-type-4').addClass('hide');
          $('.rew-type-2').removeClass('hide');
        }
      });

      // Вставка тега відгуків
      $('.create-tagReviews-btn').on('click', function() {
        var activeBlock = $('#tagReviewsModal').data('activeBlock'),
            Article = $('#tagReviewsModal').data('Article');

        // Параметри
        var count = $('#tag-reviews-count').val() ? $('#tag-reviews-count').val() : '0',
            type1 = $('#tag-reviews-type-1').prop('checked') ? $('#tag-reviews-type-1').val() : '',
            type4 = $('#tag-reviews-type-4').prop('checked') ? $('#tag-reviews-type-4').val() : '',
            type2 = $('#tag-reviews-type-2').prop('checked') ? $('#tag-reviews-type-2').val() : '',
            type = 'type='+type1+type4+type2,
            goods = [],
            goodsId = [],
            articles = [],
            articlesId = [],
            pages = [],
            pagesId = [],
            elementNoName = $('#tag-reviews_element_no_name').prop('checked') ? $('#tag-reviews_element_no_name').val() : '',
            elementNoPhoto = $('#tag-reviews_element_no_photo').prop('checked') ? $('#tag-reviews_element_no_photo').val() : '',
            text = $('#tag-reviews_text').prop('checked') ? $('#tag-reviews_text').val() : '',
            trunc = $('#tag-reviews-trunc').val() ? $('#tag-reviews-trunc').val() : '0',
            author = $('#tag-reviews_author').prop('checked') ? $('#tag-reviews_author').val() : '',
            date = $('#tag-reviews_date').prop('checked') ? $('#tag-reviews_date').val() : '',
            stars = $('#tag-reviews_stars').prop('checked') ? $('#tag-reviews_stars').val() : '',
            depth = $('#tag-reviews-depth').val() ? $('#tag-reviews-trunc').val() : '1';

        if ($('.js-select2-catalog-article-reviews option:selected').length) {
          $('.js-select2-catalog-article-reviews option:selected').each(function () {
            goods.push(sav_html($(this)));
            goodsId.push($(this).val());
          });
        }
        if ($('.js-select2-article-reviews option:selected').length) {
          $('.js-select2-article-reviews option:selected').each(function () {
            articles.push(sav_html($(this)));
            articlesId.push($(this).val());
          });
        }
        if ($('.js-select2-pages-reviews option:selected').length) {
          $('.js-select2-pages-reviews option:selected').each(function () {
            pages.push(sav_html($(this)));
            pagesId.push($(this).val());
          });
        }

        var id = '';

        if ($('#tag-reviews-type-1').prop("checked")) {
          id = goodsId.length > 0 ? 'id='+goodsId.join(',') : '';
        } else if ($('#tag-reviews-type-4').prop("checked")) {
          id = articlesId.length > 0 ? 'id='+articlesId.join(',') : '';
        } else {
          id = pagesId.length > 0 ? 'id='+pagesId.join(',') : '';
        }

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-reviews-block" '+
          'data-count="'+count+'" '+
          'data-type1="'+type1+'" '+
          'data-type4="'+type4+'" '+
          'data-type2="'+type2+'" '+
          'data-goods=\''+goods.join('\n')+'\' '+
          'data-articles=\''+articles.join('\n')+'\' '+
          'data-pages=\''+pages.join('\n')+'\' '+
          'data-elementNoName="'+elementNoName+'" '+
          'data-elementNoPhoto="'+elementNoPhoto+'" '+
          'data-text="'+text+'" '+
          'data-trunc="'+trunc+'" '+
          'data-author="'+author+'" '+
          'data-date="'+date+'" '+
          'data-stars="'+stars+'" '+
          'data-depth="'+depth+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-reviews__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">Отзывы</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<reviews '+type+' '+id+' '+elementNoName+' '+elementNoPhoto+' '+text+' trunc='+trunc+' '+author+' '+date+' '+stars+' depth='+depth+'>'+count+'</reviews>'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-reviews__button--setting').on('click', function () {
          $('.tag-reviews').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagReviewsModal').removeData('Article');
        $('#tagReviewsModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ ПОДІЙ-----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-events').on('click', function () {
      $('#tagEventsModal').remove();
      // Загрузити вікно тега подій
      $.ajax({
        url: filePath+'templates/tag-events.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagEventsModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataCount = tagBlock.attr('data-count'),
            dataPages = tagBlock.attr('data-pages'),
            dataText = tagBlock.attr('data-text'),
            dataPhoto = tagBlock.attr('data-photo'),
            dataTop = $.trim(tagBlock.attr('data-top')),
            dataDate = tagBlock.attr('data-date'),
            dataTotalCount = tagBlock.attr('data-totalCount'),
            dataPassed = tagBlock.attr('data-passed');

        $('#tag-events-count').val(dataCount);
        dataPages ? $('.js-select2-pages-events').append(dataPages) : '';
        $('#tag-events-text').val(dataText);
        dataPhoto ? $('#tag-events_photo').prop("checked", true) : '';
        dataTop ? $('#tag-events_top').prop("checked", true) : '';
        $('#tagEventsModal option').prop("selected", false);
        $('#tagEventsModal option[value="'+dataDate+'"]').prop("selected", true);
        dataTotalCount ? $('#tag-events_total_count').prop("checked", true) : '';
        dataPassed ? $('#tag-events_passed').prop("checked", true) : '';
        $('#tagEventsModal .js-select2-pages-events option').prop("selected", true);
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagEventsModal').data('activeBlock', activeBlock);
      $('#tagEventsModal').data('Article', Article);

      $('#tagEventsModal').modal('show');

      $(".js-select2-pages-events").select2({
          ajax: {
              url: "/admin/ajax/article2_pages.htm",
              data: function (params) {
                  params.q = params.term;
                  params.modules = [
                      'events'
                  ];
                  return params;
              },
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data
                  };
              },
              cache: true
          }
      });

      // Вставка тега подій
      $('.create-tagEvents-btn').on('click', function() {
        var activeBlock = $('#tagEventsModal').data('activeBlock'),
            Article = $('#tagEventsModal').data('Article');

        // Параметри
        var count = $('#tag-events-count').val() ? $('#tag-events-count').val() : '0',
            pages = [],
            pagesId = [],
            text = $('#tag-events-text').val() ? $('#tag-events-text').val() : '0',
            photo = $('#tag-events_photo').prop('checked') ? $('#tag-events_photo').val() : '',
            top = $('#tag-events_top').prop('checked') ? $('#tag-events_top').val() : '',
            date = $('#tag-events_date option:selected').length ? $('#tag-events_date option:selected').val() : '',
            totalCount = $('#tag-events_total_count').prop('checked') ? $('#tag-events_total_count').val() : '',
            passed = $('#tag-events_passed').prop('checked') ? $('#tag-events_passed').val() : '';

        if ($('.js-select2-pages-events option:selected').length) {
          $('.js-select2-pages-events option:selected').each(function () {
            pages.push(sav_html($(this)));
            pagesId.push($(this).val());
          });
        }

        var page = pagesId.length > 0 ? 'page='+pagesId.join(',') : '';

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-events-block" '+
          'data-count="'+count+'" '+
          'data-pages=\''+pages.join('\n')+'\' '+
          'data-text="'+text+'" '+
          'data-photo="'+photo+'" '+
          'data-top="'+top+'" '+
          'data-date="'+date+'" '+
          'data-totalCount="'+totalCount+'" '+
          'data-passed="'+passed+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-events__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">События</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<events '+page+' text='+text+' '+photo+' '+top+' '+date+' '+totalCount+' '+passed+'>'+count+'</events>'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-events__button--setting').on('click', function () {
          $('.tag-events').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagEventsModal').removeData('Article');
        $('#tagEventsModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ СПІВРОБІТНИКІВ -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-employees').on('click', function () {
      $('#tagEmployeesModal').remove();
      // Загрузити вікно тега співробітників
      $.ajax({
        url: filePath+'templates/tag-employees.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagEmployeesModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataCount = tagBlock.attr('data-count'),
            dataPages = tagBlock.attr('data-pages'),
            dataName = tagBlock.attr('data-name'),
            dataLastname = $.trim(tagBlock.attr('data-lastname')),
            dataFathername = tagBlock.attr('data-fathername'),
            dataPhoto = tagBlock.attr('data-photo'),
            dataShorttext = tagBlock.attr('data-shorttext'),
            dataText = tagBlock.attr('data-text'),
            dataSpec = tagBlock.attr('data-spec');
            dataExp = tagBlock.attr('data-exp');
            dataCexp = tagBlock.attr('data-cexp');


        $('#tag-employees-count').val(dataCount);
        dataPages ? $('.js-select2-pages-employees').append(dataPages) : '';
        dataName ? $('#tag-employees_name').prop("checked", true) : '';
        dataLastname ? $('#tag-employees_lastname').prop("checked", true) : '';
        dataFathername ? $('#tag-employees_fathername').prop("checked", true) : '';
        dataPhoto ? $('#tag-employees_photo').prop("checked", true) : '';
        $('#tag-employees-shorttext').val(dataShorttext);
        $('#tag-employees-text').val(dataText);
        $('#tag-employees-spec').val(dataSpec);
        dataExp ? $('#tag-employees_exp').prop("checked", true) : '';
        dataCexp ? $('#tag-employees_cexp').prop("checked", true) : '';
        $('#tagEmployeesModal option').prop("selected", true);
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagEmployeesModal').data('activeBlock', activeBlock);
      $('#tagEmployeesModal').data('Article', Article);

      $('#tagEmployeesModal').modal('show');

      $(".js-select2-pages-employees").select2({
          ajax: {
              url: "/admin/ajax/article2_pages.htm",
              data: function (params) {
                  params.q = params.term;
                  params.modules = [
                      'doctors'
                  ];
                  return params;
              },
              dataType: 'jsonp',
              delay: 250,
              processResults: function (data) {
                  return {
                      results: data
                  };
              },
              cache: true
          }
      });

      // Вставка тега співробітників
      $('.create-tagEmployees-btn').on('click', function() {
        var activeBlock = $('#tagEmployeesModal').data('activeBlock'),
            Article = $('#tagEmployeesModal').data('Article');

        // Параметри
        var count = $('#tag-employees-count').val() ? $('#tag-employees-count').val() : '0',
            pages = [],
            pagesId = [],
            name = $('#tag-employees_name').prop('checked') ? $('#tag-employees_name').val() : '',
            lastname = $('#tag-employees_lastname').prop('checked') ? $('#tag-employees_lastname').val() : '',
            fathername = $('#tag-employees_fathername').prop('checked') ? $('#tag-employees_fathername').val() : '',
            photo = $('#tag-employees_photo').prop('checked') ? $('#tag-employees_photo').val() : '',
            shorttext = $('#tag-employees-shorttext').val() ? $('#tag-employees-shorttext').val() : '0',
            text = $('#tag-employees-text').val() ? $('#tag-employees-text').val() : '0',
            spec = $('#tag-employees-spec').val() ? $('#tag-employees-spec').val() : '0',
            exp = $('#tag-employees_exp').prop('checked') ? $('#tag-employees_exp').val() : '',
            cexp = $('#tag-employees_cexp').prop('checked') ? $('#tag-employees_cexp').val() : '';

        if ($('.js-select2-pages-employees option:selected').length) {
          $('.js-select2-pages-employees option:selected').each(function () {
            pages.push(sav_html($(this)));
            pagesId.push($(this).val());
          });
        }

        var page = pagesId.length > 0 ? 'page='+pagesId.join(',') : '';

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-employees-block" '+
          'data-count="'+count+'" '+
          'data-pages=\''+pages.join('\n')+'\' '+
          'data-name="'+name+'" '+
          'data-lastname="'+lastname+'" '+
          'data-fathername="'+fathername+'" '+
          'data-photo="'+photo+'" '+
          'data-shorttext="'+shorttext+'" '+
          'data-text="'+text+'" '+
          'data-spec="'+spec+'" '+
          'data-exp="'+exp+'" '+
          'data-cexp="'+cexp+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-employees__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">Сотрудники</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<employees '+page+' '+name+' '+lastname+' '+fathername+' '+photo+' shorttext='+shorttext+' text='+text+' spec='+spec+' '+exp+' '+cexp+'>'+count+'</employees>'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-employees__button--setting').on('click', function () {
          $('.tag-employees').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagEmployeesModal').removeData('Article');
        $('#tagEmployeesModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ ФОРМ -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-forms').on('click', function () {
      $('#tagFormsModal').remove();
      // Загрузити вікно тега форм
      $.ajax({
        url: filePath+'templates/tag-forms.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagFormsModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataId = tagBlock.attr('data-id');

        if (dataId) {
          $('#tag-forms option').prop("selected", false);
          $('#tag-forms option').each(function() {
            if ($(this).val() == dataId) {
              $(this).prop("selected", true);
            }
          });
        }
        
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagFormsModal').data('activeBlock', activeBlock);
      $('#tagFormsModal').data('Article', Article);

      $('#tagFormsModal').modal('show');

      // Вставка тега форм
      $('.create-tagForms-btn').on('click', function() {
        var activeBlock = $('#tagFormsModal').data('activeBlock'),
            Article = $('#tagFormsModal').data('Article');

        // Параметри
        var id = $('#tag-forms option:selected').length ? $('#tag-forms option:selected').val() : '',
            formName = $('#tag-forms option:selected').length ? 'Форма: ' + $('#tag-forms option:selected').text() : '';

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-forms-block" '+
          'data-id="'+id+'" '+
          'data-name="'+formName+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-forms__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">'+formName+'</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<company_form>'+id+'</company_form>'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-forms__button--setting').on('click', function () {
          $('.tag-forms').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagFormsModal').removeData('Article');
        $('#tagFormsModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ КАТАЛОГА -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-catalog').on('click', function () {
      // Вставка тега каталога
      var activeBlock = $('#tagsModal').data('activeBlock');
          Article = $('#tagsModal').data('Article');

      activeBlock.removeClass('la-block--empty');
      activeBlock.find('.la-block-content').html(
        '<div class="tag-block tag-catalog-block">'+
          '<div class="tag-title">Каталог</div>'+
          '<div class="tag-image">'+
            '<img src="">'+
          '</div>'+
          '<catalog></catalog>'+
        '</div>'
      );

      activeBlock.find('.la-block-categories').hide();
      activeBlock.find('.la-block-content').show();
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ YOUTUBE -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-youtube').on('click', function () {
      $('#tagYoutubeModal').remove();
      // Загрузити вікно тега youtube
      $.ajax({
        url: filePath+'templates/tag-youtube.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagYoutubeModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataChannelId = tagBlock.attr('data-channel-id'),
            dataPlaylistId = tagBlock.attr('data-playlist-id'),
            dataVideoId = tagBlock.attr('data-video-id'),
            dataCount = tagBlock.attr('data-count'),
            dataOrder = tagBlock.attr('data-order'),
            dataAutoplay = tagBlock.attr('data-autoplay'),
            dataMute = tagBlock.attr('data-mute'),
            dataControls = tagBlock.attr('data-controls'),
            dataIvLoadPolicy = tagBlock.attr('data-iv-load-policy'),
            dataRel = tagBlock.attr('data-rel'),
            dataModestbranding = tagBlock.attr('data-modestbranding'),
            dataShowinfo = tagBlock.attr('data-showinfo'),
            dataInLine = tagBlock.attr('data-in-line'),
            dataType = tagBlock.attr('data-type'),
            dataChannelBanner = tagBlock.attr('data-channel-banner'),
            dataChannelLogo = tagBlock.attr('data-channel-logo'),
            dataChannelTitle = tagBlock.attr('data-channel-title'),
            dataChannelDescription = tagBlock.attr('data-channel-description'),
            dataChannelView = tagBlock.attr('data-channel-view'),
            dataChannelSubscriber = tagBlock.attr('data-channel-subscriber'),
            dataChannelVideo = tagBlock.attr('data-channel-video'),
            dataVideoView = tagBlock.attr('data-video-view'),
            dataVideoLike = tagBlock.attr('data-video-like'),
            dataVideoDislike = tagBlock.attr('data-video-dislike'),
            dataVideoComment = tagBlock.attr('data-video-comment');

        if (dataType == 'channel') {
          $('#search-type option').prop("selected", false);
          $('#search-type option[value="channel"]').prop("selected", true);
          $('#tagYoutubeModal .playlist').hide();
          $('#tagYoutubeModal .video').hide();
          $('#tagYoutubeModal .channel').show();
        } else if (dataType == 'playlist') {
          $('#search-type option').prop("selected", false);
          $('#search-type option[value="playlist"]').prop("selected", true);
          $('#tagYoutubeModal .channel').hide();
          $('#tagYoutubeModal .video').hide();
          $('#tagYoutubeModal .playlist').show();
        } else if (dataType == 'video') {
          $('#search-type option').prop("selected", false);
          $('#search-type option[value="video"]').prop("selected", true);
          $('#tagYoutubeModal .channel').hide();
          $('#tagYoutubeModal .playlist').hide();
          $('#tagYoutubeModal .video').show();
        }
        if (dataChannelId) {
          $('#channel-id').val(dataChannelId);
        }
        if (dataPlaylistId) {
          $('#playlist-id').val(dataPlaylistId);
        }
        if (dataVideoId) {
          $('#video-id').val(dataVideoId);
        }
        $('#video-count').val(dataCount);
        if (dataOrder) {
          $('#video-order option').prop("selected", false);
          $('#video-order option[value="'+dataOrder+'"]').prop("selected", true);
        }
        dataAutoplay ? $('#player-autoplay').prop("checked", true) : '';
        dataMute ? $('#player-mute').prop("checked", true) : '';
        dataControls ? $('#player-controls').prop("checked", true) : '';
        dataIvLoadPolicy ? $('#player-iv-load-policy').prop("checked", true) : '';
        dataRel ? $('#player-rel').prop("checked", true) : '';
        if (dataModestbranding) { 
          $('#player-showinfo').prop("checked", false);
          $('#player-modestbranding').prop("checked", true);
        } else if (dataShowinfo) {
          $('#player-modestbranding').prop("checked", false);
          $('#player-showinfo').prop("checked", true);
        }
        if (dataInLine) {
          $('#video-order option').prop("selected", false);
          $('#video-in-line option[value="'+dataInLine+'"]').prop("selected", true);
        }
        if (dataChannelBanner) {
          $('#channel-banner').prop("checked", true);
        }
        if (dataChannelLogo) {
          $('#channel-logo').prop("checked", true);
        }
        if (dataChannelTitle) {
          $('#channel-title').prop("checked", true);
        }
        if (dataChannelDescription) {
          $('#channel-description').prop("checked", true);
        }
        if (dataChannelView) {
          $('#channel-view').prop("checked", true);
        }
        if (dataChannelSubscriber) {
          $('#channel-subscriber').prop("checked", true);
        }
        if (dataChannelVideo) {
          $('#channel-video').prop("checked", true);
        }
        if (dataVideoView) {
          $('#video-view').prop("checked", true);
        }
        if (dataVideoLike) {
          $('#video-like').prop("checked", true);
        }
        if (dataVideoDislike) {
          $('#video-dislike').prop("checked", true);
        }
        if (dataVideoComment) {
          $('#video-comment').prop("checked", true);
        }
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagYoutubeModal').data('activeBlock', activeBlock);
      $('#tagYoutubeModal').data('Article', Article);

      $('#tagYoutubeModal').modal('show');

      $('#search-type').on('change', function () {
        if ($(this).find('option:selected').val() == 'channel') {
          $('#tagYoutubeModal .playlist').hide();
          $('#tagYoutubeModal .video').hide();
          $('#tagYoutubeModal .channel').show();
        } else if ($(this).find('option:selected').val() == 'playlist') {
          $('#tagYoutubeModal .channel').hide();
          $('#tagYoutubeModal .video').hide();
          $('#tagYoutubeModal .playlist').show();
        } else if ($(this).find('option:selected').val() == 'video') {
          $('#tagYoutubeModal .channel').hide();
          $('#tagYoutubeModal .playlist').hide();
          $('#tagYoutubeModal .video').show();
        } 
      });
      // $('#player-modestbranding').on('change', function () {
      //   if ($(this).prop("checked")) {
      //     $('#player-showinfo').prop("disabled", true);
      //   } else {
      //     $('#player-showinfo').prop("disabled", false);
      //   }
      // });
      // $('#player-showinfo').on('change', function () {
      //   if ($(this).prop("checked")) {
      //     $('#player-modestbranding').prop("disabled", true);
      //   } else {
      //     $('#player-modestbranding').prop("disabled", false);
      //   }
      // });

      // Вставка тега youtube
      $('.create-tagYoutube-btn').on('click', function() {
        var activeBlock = $('#tagYoutubeModal').data('activeBlock'),
            Article = $('#tagYoutubeModal').data('Article');

        // Параметри
        var type = $('#search-type option:selected').val(),
            channelId = $('#channel-id').val() ? $('#channel-id').val() : '',
            playlistId = $('#playlist-id').val() ? $('#playlist-id').val() : '',
            videoId = $('#video-id').val() ? $('#video-id').val() : '',
            count = $('#video-count').val() ? $('#video-count').val() : '0',
            order = $('#video-order option:selected').val(),
            autoplay = $('#player-autoplay').prop('checked') ? ' autoplay' : '',
            mute = $('#player-mute').prop('checked') ? ' mute' : '',
            controls = $('#player-controls').prop('checked') ? true : '',
            ivLoadPolicy = $('#player-iv-load-policy').prop('checked') ? true : '',
            rel = $('#player-rel').prop('checked') ? true : '',
            modestbranding = $('#player-modestbranding').prop('checked') ? true : '',
            showinfo = $('#player-showinfo').prop('checked') ? true : '',
            inLine = $('#video-in-line option:selected').val(),
            channelBanner = $('#channel-banner').prop('checked') ? true : '',
            channelLogo = $('#channel-logo').prop('checked') ? true : '',
            channelTitle = $('#channel-title').prop('checked') ? true : '',
            channelDescription = $('#channel-description').prop('checked') ? true : '',
            channelView = $('#channel-view').prop('checked') ? true : '',
            channelSubscriber = $('#channel-subscriber').prop('checked') ? true : '',
            channelVideo = $('#channel-video').prop('checked') ? true : '',
            videoView = $('#video-view').prop('checked') ? true : '',
            videoLike = $('#video-like').prop('checked') ? true : '',
            videoDislike = $('#video-dislike').prop('checked') ? true : '',
            videoComment = $('#video-comment').prop('checked') ? true : '',
            hasChannelInfo = (channelBanner || channelLogo || channelTitle || channelDescription || channelView || channelSubscriber || channelVideo) ? ' has-channel-info' : '',
            hasVideoInfo = (videoView || videoLike || videoDislike || videoComment) ? ' has-video-info' : '';

        if (channelId.indexOf("youtube") != -1 && channelId.indexOf("channel") != -1) {
          channelId = channelId.split('/');
          channelId = channelId[channelId.length-1];
          // console.log(channelId);
        }
        if (playlistId.indexOf("youtube") != -1 && playlistId.indexOf("list") != -1) {
          playlistId = playlistId.split('list=');
          playlistId = playlistId[playlistId.length-1];
          playlistId = playlistId.split('&');
          playlistId = playlistId[0];
          // console.log(playlistId);
        }
        if (videoId.indexOf("youtube") != -1 && videoId.indexOf("v=") != -1) {
          videoId = videoId.split('v=');
          videoId = videoId[videoId.length-1];
          videoId = videoId.split('&');
          videoId = videoId[0];
          // console.log(videoId);
        } else if (videoId.indexOf("youtu.be") != -1) {
            videoId = videoId.split('.be/');
            videoId = videoId[1];
        }

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-youtube-block '+type+hasChannelInfo+hasVideoInfo+'" '+
          'data-type="'+type+'" '+
          'data-channel-id="'+channelId+'" '+
          'data-playlist-id="'+playlistId+'" '+
          'data-video-id="'+videoId+'" '+
          'data-count="'+count+'" '+
          'data-order="'+order+'" '+
          'data-autoplay="'+autoplay+'" '+
          'data-mute="'+mute+'" '+
          'data-controls="'+controls+'" '+
          'data-iv-load-policy="'+ivLoadPolicy+'" '+
          'data-rel="'+rel+'" '+
          'data-modestbranding="'+modestbranding+'" '+
          'data-showinfo="'+showinfo+'" '+
          'data-in-line="'+inLine+'" '+
          'data-channel-banner="'+channelBanner+'" '+
          'data-channel-logo="'+channelLogo+'" '+
          'data-channel-title="'+channelTitle+'" '+
          'data-channel-description="'+channelDescription+'" '+
          'data-channel-view="'+channelView+'" '+
          'data-channel-subscriber="'+channelSubscriber+'" '+
          'data-channel-video="'+channelVideo+'" '+
          'data-video-view="'+videoView+'" '+
          'data-video-like="'+videoLike+'" '+
          'data-video-dislike="'+videoDislike+'" '+
          'data-video-comment="'+videoComment+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-youtube__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">Youtube видео</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<div class="youtube-playlist video-in-line-'+inLine+autoplay+mute+'"></div>'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-youtube__button--setting').on('click', function () {
          $('.tag-youtube').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagYoutubeModal').removeData('Article');
        $('#tagYoutubeModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ INSTAGRAM -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-instagram').on('click', function () {
      $('#tagInstagramModal').remove();
      // Загрузити вікно тега instagram
      $.ajax({
        url: filePath+'templates/tag-instagram.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagInstagramModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataUser = tagBlock.attr('data-user'),
            dataAccessToken = tagBlock.attr('data-access-token'),
            dataCount = tagBlock.attr('data-count'),
            dataHashtags = tagBlock.attr('data-hashtags'),
            dataWidgetMode = tagBlock.attr('data-widget-mode'),
            dataDisplayMode = tagBlock.attr('data-display-mode'),
            dataAvatar = tagBlock.attr('data-avatar');

        $('#inst-user').val(dataUser);
        $('#access-token').val(dataAccessToken);
        $('#inst-count').val(dataCount);
        $('#hashtags').val(dataHashtags);
        dataWidgetMode ? $('#widget-mode').prop("checked", true) : '';
        if (dataDisplayMode) {
          $('#video-order option').prop("selected", false);
          $('#video-order option[value="'+dataDisplayMode+'"]').prop("selected", true);
        }
        dataAvatar ? $('#avatar').prop("checked", true) : '';
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagInstagramModal').data('activeBlock', activeBlock);
      $('#tagInstagramModal').data('Article', Article);

      $('#tagInstagramModal').modal('show');

      // Вставка тега instagram
      $('.create-tagInstagram-btn').on('click', function() {
        var activeBlock = $('#tagInstagramModal').data('activeBlock'),
            Article = $('#tagInstagramModal').data('Article');

        // Параметри
        var user = $('#inst-user').val() ? $('#inst-user').val() : '',
            accessToken = $('#access-token').val() ? $('#access-token').val() : '',
            count = $('#inst-count').val() ? $('#inst-count').val() : '1',
            hashtags = $('#hashtags').val() ? $('#hashtags').val() : '',
            widgetMode = $('#widget-mode').prop('checked') ? ' widget-mode' : '',
            displayMode = $('#display-mode option:selected').val(),
            avatar = $('#avatar').prop('checked') ? ' no-avatar' : '';

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-instagram-block'+avatar+widgetMode+'" '+
          'data-user="'+user+'" '+
          'data-access-token="'+accessToken+'" '+
          'data-count="'+count+'" '+
          'data-hashtags="'+hashtags+'" '+
          'data-widget-mode="'+widgetMode+'" '+
          'data-display-mode="'+displayMode+'" '+
          'data-avatar="'+avatar+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-instagram__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">Instagram фото</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<div class="instamax"></div>'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-instagram__button--setting').on('click', function () {
          $('.tag-instagram').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagInstagramModal').removeData('Article');
        $('#tagInstagramModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ VK PHOTO -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-vk_photo').on('click', function () {
      $('#tagVkPhotoModal').remove();
      // Загрузити вікно тега vk_photo
      $.ajax({
        url: filePath+'templates/tag-vk_photo.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagVkPhotoModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataUser = tagBlock.attr('data-user'),
            dataAlbum = tagBlock.attr('data-album'),
            dataCount = tagBlock.attr('data-count'),
            dataTypeShow = tagBlock.attr('data-type-show'),
            dataUserInfo = tagBlock.attr('data-user-info'),
            dataLikes = tagBlock.attr('data-likes'),
            dataReposts = tagBlock.attr('data-reposts'),
            dataComments = tagBlock.attr('data-comments'),
            dataPhotoInLine = tagBlock.attr('data-photo-in-line'),
            dataTypeSearch = tagBlock.attr('data-type-search'),
            dataOffset = tagBlock.attr('data-offset'),
            dataRev = tagBlock.attr('data-rev');

        $('#owner_id').val(dataUser);
        $('#album_id').val(dataAlbum);
        $('#vk-count').val(dataCount);
        $('#vk-offset').val(dataOffset);
        if (dataTypeShow != 'preview') {
          $('#type-show option').prop("selected", false);
          $('#type-show option[value="'+dataTypeShow+'"]').prop("selected", true);
          $('.vk-preview').hide();
        }
        dataUserInfo ? $('#vk-user').prop("checked", true) : '';
        dataLikes ? $('#vk-likes').prop("checked", true) : '';
        dataReposts ? $('#vk-reposts').prop("checked", true) : '';
        dataComments ? $('#vk-comments').prop("checked", true) : '';
        if (dataPhotoInLine) {
          $('#vk-photo-in-line option').prop("selected", false);
          $('#vk-photo-in-line option[value="'+dataPhotoInLine+'"]').prop("selected", true);
        }
        if (dataTypeSearch) {
          $('#type-search option').prop("selected", false);
          $('#type-search option[value="'+dataTypeSearch+'"]').prop("selected", true);
        }
        if (dataRev) {
          $('#vk-rev-off').prop("checked", false);
          $('#vk-rev-on').prop("checked", true);
        }
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagVkPhotoModal').data('activeBlock', activeBlock);
      $('#tagVkPhotoModal').data('Article', Article);

      $('#tagVkPhotoModal').modal('show');

      $('#type-show').on('change', function () {
        if ($(this).find('option:selected').val() == 'preview') {
          $('.vk-preview').show();
        } else {
          $('.vk-preview').hide();
        } 
      });

      // Вставка тега vk_photo
      $('.create-tagVkPhoto-btn').on('click', function() {
        var activeBlock = $('#tagVkPhotoModal').data('activeBlock'),
            Article = $('#tagVkPhotoModal').data('Article');

        // Параметри
        var user = $('#owner_id').val() ? $('#owner_id').val() : '',
            album = $('#album_id').val() ? $('#album_id').val() : '',
            count = $('#vk-count').val() ? $('#vk-count').val() : '1',
            typeShow = $('#type-show option:selected').val(),
            userInfo = $('#vk-user').prop('checked') ? 'user-info' : '',
            likes = $('#vk-likes').prop('checked') ? 'likes' : '',
            reposts = $('#vk-reposts').prop('checked') ? 'reposts' : '',
            comments = $('#vk-comments').prop('checked') ? 'comments' : '',
            photoInLine = $('#vk-photo-in-line option:selected').val(),
            typeSearch = $('#type-search option:selected').val(),
            offset = $('#vk-offset').val() ? $('#vk-offset').val() : '0',
            rev = $('#vk-rev-on').prop('checked') ? $('#vk-rev-on').val() : '';

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-vk_photo-block" '+
          'data-user="'+user+'" '+
          'data-album="'+album+'" '+
          'data-count="'+count+'" '+
          'data-type-show="'+typeShow+'" '+
          'data-user-info="'+userInfo+'" '+
          'data-likes="'+likes+'" '+
          'data-reposts="'+reposts+'" '+
          'data-comments="'+comments+'" '+
          'data-photo-in-line="'+photoInLine+'" '+
          'data-type-search="'+typeSearch+'" '+
          'data-offset="'+offset+'" '+
          'data-rev="'+rev+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-vk_photo__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">Vk фото</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<div class="vk_photo vk-photo-in-line-'+photoInLine+'"></div>'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-vk_photo__button--setting').on('click', function () {
          $('.tag-vk_photo').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagVkPhotoModal').removeData('Article');
        $('#tagVkPhotoModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ VK POST -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-vk_post').on('click', function () {
      $('#tagVkPostModal').remove();
      // Загрузити вікно тега vk_post
      $.ajax({
        url: filePath+'templates/tag-vk_post.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagVkPostModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataType = tagBlock.attr('data-type'),
            dataCode = tagBlock.find('.data-code').text();

        $('#vk-post-code').val(dataCode);
        if (dataType != 'post') {
          $('#type-code option').prop("selected", false);
          $('#type-code option[value="'+dataType+'"]').prop("selected", true);
        }
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagVkPostModal').data('activeBlock', activeBlock);
      $('#tagVkPostModal').data('Article', Article);

      $('#tagVkPostModal').modal('show');

      // Вставка тега vk_post
      $('.create-tagVkPost-btn').on('click', function() {
        var activeBlock = $('#tagVkPostModal').data('activeBlock'),
            Article = $('#tagVkPostModal').data('Article');

        // Параметри
        var type = $('#type-code option:selected').val(),
            code = $('#vk-post-code').val();

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-vk_post-block" '+
          'data-type="'+type+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-vk_post__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">Vk пост/опрос</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<div class="data-code hide hidden" style="display: none;"></div>'+
            '<div class="vk_post_wrp"></div>'+
          '</div>'
        );
        activeBlock.find('.la-block-content .data-code').text(code);

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-vk_post__button--setting').on('click', function () {
          $('.tag-vk_post').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagVkPostModal').removeData('Article');
        $('#tagVkPostModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ JAVASCRIPT -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-js').on('click', function () {
      $('#tagJSModal').remove();
      // Загрузити вікно тега vk_post
      $.ajax({
        url: filePath+'templates/tag-js.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagJSModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataCode = tagBlock.find('.data-code').text();

        $('#js-code').val(dataCode);
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagJSModal').data('activeBlock', activeBlock);
      $('#tagJSModal').data('Article', Article);

      $('#tagJSModal').modal('show');

      // Вставка тега javascript
      $('.create-tagJS-btn').on('click', function() {
        var activeBlock = $('#tagJSModal').data('activeBlock'),
            Article = $('#tagJSModal').data('Article');

        // Параметри
        var code = $('#js-code').val();

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-js-block">'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-js__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">javaScript</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<div class="data-code hide hidden" style="display: none;"></div>'+
            '<div class="js_wrp"></div>'+
          '</div>'
        );
        activeBlock.find('.la-block-content .data-code').text(code);

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-js__button--setting').on('click', function () {
          $('.tag-js').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagJSModal').removeData('Article');
        $('#tagJSModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ ГОЛОСУВАННЯ -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-voting').on('click', function () {
      $('#tagVotingModal').remove();
      // Загрузити вікно тега голосування
      $.ajax({
        url: filePath+'templates/tag-voting.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagVotingModal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataId = tagBlock.attr('data-id');

        if (dataId) {
          $('#tag-voting option').prop("selected", false);
          $('#tag-voting option').each(function() {
            if ($(this).val() == dataId) {
              $(this).prop("selected", true);
            }
          });
        }
        
        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagVotingModal').data('activeBlock', activeBlock);
      $('#tagVotingModal').data('Article', Article);

      $('#tagVotingModal').modal('show');

      // Вставка тега голосування
      $('.create-tagVoting-btn').on('click', function() {
        var activeBlock = $('#tagVotingModal').data('activeBlock'),
            Article = $('#tagVotingModal').data('Article');

        // Параметри
        var id = $('#tag-voting option:selected').length ? $('#tag-voting option:selected').val() : '',
            votingName = $('#tag-voting option:selected').length ? 'Голосование: ' + $('#tag-voting option:selected').text() : '';

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-voting-block" '+
          'data-id="'+id+'" '+
          'data-name="'+votingName+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-voting__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">'+votingName+'</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            '<voting value="'+id+'" />'+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-voting__button--setting').on('click', function () {
          $('.tag-voting').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagVotingModal').removeData('Article');
        $('#tagVotingModal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------


    // ТЕГ INSTAGRAM PROFILE -----------------------------------------------------------------------------------------------------------------------------------
    $('.tag-instagram2').on('click', function () {
      $('#tagInstagram2Modal').remove();
      // Загрузити вікно тега instagram2
      $.ajax({
        url: filePath+'templates/tag-instagram2.html',
        async: false,
        dataType: 'html',
        success: function (data) {
          $('body').append(data);
          $('#tagInstagram2Modal').on('show.bs.modal', function (e) {
            $(this).find('.modal-body').css({
              'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
            });
          });
        }
      });

      var activeBlock = '',
          Article = '';

      if ($(this).hasClass('edit-tag')) {
        activeBlock = $(this).data('activeBlock');
        Article = $(this).data('Article');

        $(this).removeData('Article'),
        $(this).removeData('activeBlock');

        var tagBlock = activeBlock.find('.tag-block'),
            dataCels = tagBlock.attr('data-cels');

        if (dataCels) {
          $('#tag-instagram2-cels option').prop("selected", false);
          $('#tag-instagram2-cels option').each(function() {
            if ($(this).val() == dataCels) {
              $(this).prop("selected", true);
            }
          });
        }

        if (tagBlock.find('.instagram-profile').length > 1) {
          for (var i = 1; i < tagBlock.find('.instagram-profile').length; i++) {
            $('#tagInstagram2Modal').find('.add-tagInstagram2-profile-btn').trigger('click');
          }
        }

        tagBlock.find('.instagram-profile').each(function(index, el) {
          var dataLink = $(this).attr('data-link'),
              dataTitle = $(this).find('.instagram-profile-title').text(),
              dataDesc = $(this).find('.instagram-profile-desc').text(),
              instagramProfile = $('#tagInstagram2Modal').find('.tag-instagram2-profile').eq(index);

          instagramProfile.find('#tag-instagram2-url').val(dataLink);
          instagramProfile.find('#tag-instagram2-title').val(dataTitle);
          instagramProfile.find('#tag-instagram2-desc').val(dataDesc);
        });

        $(this).removeClass('edit-tag');
      } else {
        activeBlock = $('#tagsModal').data('activeBlock');
        Article = $('#tagsModal').data('Article');

        $('#tagsModal').removeData('Article'),
        $('#tagsModal').removeData('activeBlock');
      }

      $('#tagInstagram2Modal').data('activeBlock', activeBlock);
      $('#tagInstagram2Modal').data('Article', Article);

      $('#tagInstagram2Modal').modal('show');

      // Вставка тега vk_post
      $('.create-tagInstagram2-btn').on('click', function() {
        var activeBlock = $('#tagInstagram2Modal').data('activeBlock'),
            Article = $('#tagInstagram2Modal').data('Article');

        // Параметри
        var cels = $('#tag-instagram2-cels option:selected').val(),
            html = '<div class="instagram-profiles instagram-profiles-'+cels+'">';
            

        $('#tagInstagram2Modal').find('.tag-instagram2-profile').each(function(index, el) {
          var url = $(this).find('#tag-instagram2-url').val(),
              title = $(this).find('#tag-instagram2-title').val(),
              desc = $(this).find('#tag-instagram2-desc').val();

          html += '<div class="instagram-profile" data-link="'+url+'">';
          html += '<div class="instagram-profile-img">';
          html += '<a class="instagram-profile-link" href="'+url+'" target="_blank"></a>';
          html += '<span class="instagram-profile-followers"><span class="instagram-profile-followers-count"></span>Подписчиков</span>';
          html += '</div>';
          html += '<div class="instagram-profile-title"><a href="'+url+'" target="_blank">'+title+'</a></div>';
          html += '<div class="instagram-profile-desc">'+desc+'</div>';
          html += '</div>';
        });

        html += '</div>';

        activeBlock.removeClass('la-block--empty');
        activeBlock.find('.la-block-content').html(
          '<div class="tag-block tag-instagram2-block" '+
          'data-cels="'+cels+'" '+
          '>'+
            '<div class="tag-control">'+
              '<button type="button" class="btn btn-default btn-sm tag-instagram2__button--setting"><i class="material-icons ic_settings"></i></button>'+
            '</div>'+
            '<div class="tag-title">Instagram профиль</div>'+
            '<div class="tag-image">'+
              '<img src="">'+
            '</div>'+
            html+
          '</div>'
        );

        activeBlock.find('.la-block-categories').hide();
        activeBlock.find('.la-block-content').show();

        activeBlock.find('.tag-instagram2__button--setting').on('click', function () {
          $('.tag-instagram2').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
        });

        // Article.SaveContent(activeBlock.closest('.la-section')); vsv
        $('.js-mobile-header-save-btn').fadeIn();
        $('.js-save-btn').fadeIn();
        $('.js-mobile-header-saved').hide();
        $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

        $('#tagInstagram2Modal').removeData('Article');
        $('#tagInstagram2Modal').removeData('activeBlock');
      });
    });
    // --------------------------------------------------------------------------------------------------------------------------------------------------



    // Вибір сітки 
    $('.create-grid-btn').on('click', function (event) {
      event.preventDefault();

      var Article = $(this).closest('#gridModal').data('Article'),
          activeSection = $(this).closest('#gridModal').data('activeSection'),
          createGrid = $(this).closest('#gridModal').data('createGrid');

      activeSection.closest('.lb-container').removeClass('no-content').addClass('has-content');

      // Визначення потрібної сітки
      var Type = $(this).closest('#gridModal').find('.grid-item.active a').data('grid').toString();
      activeSection.attr('data-active-grid', Type);

      if (Type.search(/\-/) < 0) {
        Type = [12];
      } else {
        Type = Type.split('-');
      }

      // Збереження створених блоків у масив для подальшого відновлення
      var AllBlocks = [],
          count = 0;
      activeSection.find('.la-grid > .lb-row > .grid-block').each(function () {
        $(this).find('.la-block--empty').parent().remove();
        if ($(this).find('.la-block:not(.la-block--empty)').length) {
          AllBlocks[count++] = $(this).html();
        }
      });

      if (AllBlocks.length > Type.length) {
        if (!confirm('Деякі блоки не поміщаються у вибрану сітку. Продовжити з втратою блоків?')) return false;
      }

      // Генерація нової сітки разом із збереженими блоками
      var GeneratedGrid = Article.Template.NewGrid($(this).closest('#gridModal').find('.grid-item.active a').data('grid'), AllBlocks);

      // Додавання сітки до секції
      activeSection.find('.la-grid > .lb-row').html(GeneratedGrid);

      if (createGrid) {
        // Видалити мітку про те, що секція пуста
        activeSection.removeClass('la-section--empty');

        // Показати меню вибору типу блоку
        activeSection.find('.la-block-plus').hide();
        activeSection.find('.la-block-categories').show();
        activeSection.find('.la-block').removeClass('la-block--noactive');

        // Добавити проміжні пусті секції
        if (!activeSection.parent().prev('.lb-row').find('.la-section--empty').length) {
          Article.AddSection('Before', activeSection);
        } 
        if (!activeSection.parent().next('.lb-row').find('.la-section--empty').length) {
          Article.AddSection('After', activeSection);
        }

        // Ініціалізація блоків
        activeSection.find('.la-block').each(function () {
          // Очистити зайві компоненти
          $(this).find('.la-block-content__editable').removeAttr('id').removeClass('mce-content-body');

          // Ініціалізувати блок
          Article.LinkyArticleBlock($(this));

          // Задіяти TinyMCE до відповідного блоку
          var BlockType = $(this).find('.la-block-content__editable').data('type');

          if (BlockType && BlockType in Article.TinyMCE) {
            Article.TinyMCE.Init(BlockType);
          }

          if (BlockType && BlockType === 'Image' && BlockType in Article.BlockCustom) {
            Article.BlockCustom.Image($(this));
          }

          Article.AddBothSectionGrid($(this));
        });
      } else {
        
        activeSection.find('.grid-block').each(function () {
            // Ініціалізація блоків
            $(this).find('.la-block').each(function () {

              // Показати меню вибору типу блоку
              if ($(this).hasClass('la-block--empty')) {
                $(this).find('.la-block-plus').hide();
                $(this).find('.la-block-categories').show();
                $(this).removeClass('la-block--noactive');
              } else {
                $(this).find('.la-control').remove();
                $(this).find('.la-block-categories').remove();
                $(this).find('.la-block-plus').remove();
                $(this).find('.la-block-menu').remove();
              }

              // Очистити зайві компоненти
              $(this).find('.la-block-content__editable').removeAttr('id').removeClass('mce-content-body');

              // Ініціалізувати блок
              Article.LinkyArticleBlock($(this));

              // Задіяти TinyMCE до відповідного блоку
              var BlockType = $(this).find('.la-block-content__editable').data('type');

              // if (BlockType && BlockType in Article.TinyMCE) {
              //   Article.TinyMCE.Init(BlockType);
              // }

              // if (BlockType && BlockType === 'Image' && BlockType in Article.BlockCustom) {
              //   Article.BlockCustom.Image($(this));
              // }

              // Добавити проміжні пусті блоки
              if (!$(this).parent().prev('.lb-row').find('.la-block--empty').length) {
                Article.AddBothBlockGrid('Before', $(this));
              } 
              if (!$(this).parent().next('.lb-row').find('.la-block--empty').length) {
                Article.AddBothBlockGrid('After', $(this));
              }
            });
        });

        $(this).removeClass('change-grid-btn');
      }

      $('#gridModal').removeData('Article'),
      $('#gridModal').removeData('activeSection');

      //console.log('l#976');
      // Article.SaveContent(activeSection); vsv
      $('.js-mobile-header-save-btn').fadeIn();
      $('.js-save-btn').fadeIn();
      $('.js-mobile-header-saved').hide();
      $('.js-mobile-header-unsaved').addClass('showed').fadeIn()
    });


    // Задати id секції
    $('.create-id-btn').on('click', function() {
      var activeSection = $('#idModal').data('activeSection'),
          createIdBtn = $('#idModal').data('createIdBtn'),
          Article = $('#idModal').data('Article');
      if ($('#id-name').val() === '') {
        activeSection.removeAttr('id');
      } else {
        activeSection.attr({'id':$('#id-name').val()});
      }
      createIdBtn.closest('.la-toolbar__button--id-wrp').hide();
      createIdBtn.closest('.la-toolbar').find('.la-toolbar__button--toggle').trigger('click');

      $('#id-name').val('');
      $('#idModal').removeData('Article'),
      $('#idModal').removeData('activeSection');
      $('#idModal').removeData('createIdBtn');

      // Article.SaveContent(activeSection); vsv
      $('.js-mobile-header-save-btn').fadeIn();
      $('.js-save-btn').fadeIn();
      $('.js-mobile-header-saved').hide();
      $('.js-mobile-header-unsaved').addClass('showed').fadeIn()
    });


    // Задати cass для секції/блока
    $('.create-class-btn').on('click', function() {
      if ($(this).hasClass('create-class-block-btn')) {
          var activeBlock = $('#classModal').data('activeBlock');
              createClassBtn = $('#classModal').data('createClassBtn');
              Article = $('#classModal').data('Article');
              blockClass = $('#class-name').val();
              blockNclass = '';
              $('#classModal .nclass-wrp.active .nclass').each(function(index) {
                if (index == 0) {
                  blockNclass = $(this).attr('data-nclass-val');
                } else {
                  blockNclass += ' ' + $(this).attr('data-nclass-val');
                }
              });

          if (activeBlock.attr('data-class')) {
            activeBlock.removeClass(activeBlock.attr('data-class'));
          }
          if (blockClass === '') {
            activeBlock.removeClass(activeBlock.attr('data-class'));
            activeBlock.removeAttr('data-class');
          } else {
            activeBlock.addClass(blockClass).attr({'data-class':blockClass});
          }

          if (activeBlock.attr('data-nclass')) {
            activeBlock.removeClass(activeBlock.attr('data-nclass'));
          }
          if (blockNclass === '') {
            activeBlock.removeClass(activeBlock.attr('data-nclass'));
            activeBlock.removeAttr('data-nclass');
          } else {
            activeBlock.addClass(blockNclass).attr({'data-nclass':blockNclass});
          }

          // Article.SaveContent(activeBlock.closest('.la-section')); vsv
          $('.js-mobile-header-save-btn').fadeIn();
          $('.js-save-btn').fadeIn();
          $('.js-mobile-header-saved').hide();
          $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
 

          $('#classModal .classes').html('');
          $('#class-name').val('');
          $('#classModal').removeData('Article'),
          $('#classModal').removeData('activeBlock');
          $('#classModal').removeData('createClassBtn');
          $(this).removeClass('create-class-block-btn');

      } else {
          var activeSection = $('#classModal').data('activeSection');
              createClassBtn = $('#classModal').data('createClassBtn');
              Article = $('#classModal').data('Article');
              sectionClass = $('#class-name').val();

          if (activeSection.attr('data-class')) {
            activeSection.removeClass(activeSection.attr('data-class'));
          }
          if (sectionClass === '') {
            activeSection.removeClass(activeSection.attr('data-class'));
            activeSection.removeAttr('data-class');
          } else {
            activeSection.addClass(sectionClass).attr({'data-class':sectionClass});
          }
          createClassBtn.closest('.la-toolbar__button--section-class-wrp').hide();
          createClassBtn.closest('.la-toolbar').find('.la-toolbar__button--toggle').trigger('click');

          // Article.SaveContent(activeSection); vsv
          $('.js-mobile-header-save-btn').fadeIn();
          $('.js-save-btn').fadeIn();
          $('.js-mobile-header-saved').hide();
          $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
 

          $('#class-name').val('');
          $('#classModal').removeData('Article'),
          $('#classModal').removeData('activeSection');
          $('#classModal').removeData('createClassBtn');
      }
    });

    // Перевірити чи є копія сторінки
    $.ajax({
      url: $(".js-redactor").attr("data-url") + '&action=buffer',
      data: {
        key: 'redactorContent',
      },
      dataType: 'jsonp',
      method: 'GET',
      success: function (data) {
        if (data.error) {
          $('body').addClass('no-copy-page');
          return;
        }
      }
    });

    
    // Перевірити чи є копія секції
    $.ajax({
      url: $(".js-redactor").attr("data-url") + '&action=buffer',
      data: {
        key: 'redactorSection',
      },
      dataType: 'jsonp',
      method: 'GET',
      success: function (data) {
        if (data.error) {
          $('body').addClass('no-copy-section');
          return;
        }
      }
    });

    // Перевірити чи є копія блоку
    $.ajax({
      url: $(".js-redactor").attr("data-url") + '&action=buffer',
      data: {
        key: 'redactorBlock',
      },
      dataType: 'jsonp',
      method: 'GET',
      success: function (data) {
        if (data.error) {
          $('body').addClass('no-copy-block');
          return;
        }
      }
    });




    // Завантажити список готових класів
    $.ajax({
      url: $(".js-redactor").attr("data-url") + '&action=blocks-classes',
      async: false,
      dataType: 'jsonp',
      method: 'GET',
      success: function (data) {
        classesObject = data;
        console.log('classesObject', classesObject);
      },
      error: function (err) {
        console.log(err);
      }
    });




    // Завантажити вікно створення нового шаблону
    $.ajax({
      url: filePath+'templates/create_template_modal.html',
      async: false,
      dataType: 'html',
      success: function (data) {
        $('body').append(data);
        // Створення нового шаблону
        $('.create-template-btn').on('click', function() {
          var templateContentUrl = $('#createTemplateModal').data('templateContentUrl'),
              name = $('#id-template-name').val();

          if (!name) {
            alert('Не указано имя шаблона. Укажите пожалуйста имя.');
            return;
          }
          $.ajax({
            url: templateContentUrl,
            data: {
              act: 'create',
              name: name
            },
            dataType: 'jsonp',
            method: 'POST',
            success: function (data) {
              console.log(data);
            }
          });

          $('#id-template-name').val('');
          $('#createTemplateModal').removeData('templateContentUrl');
          $('#createTemplateModal').modal('hide');
        });
      }
    });
  });


  










































  

  // Ініціалізація редактора
  $.fn.LinkyArticle = function (Options) {

    // Перебір усіх ініціалізованих textarea
    this.each(function () {
      var textareaId = $(this).attr('id');

      // Головний об'єкт редактора
      var Article = {

        // Налаштування редактора
        Config: $.extend({}, {
          Placeholder: $(this), // Куди саме буде добавлений контейнер поточного редактора (через .append() )
          DefaultGrid: '12', // Стандартна сітка, яка використовується при створенні секції
          AllowGrids: ['12', '6-6', '8-4', '9-3', '4-8', '3-9', '7-5', '5-7', '4-4-4', '3-3-3-3'] // Усі можливі варіанти сіток
        }, Options),

        // Головні контейнери редактора
        Storage: {
          Container: null,
          Prehtml: null,
          Textarea: null
        },

        // Загальні функції редактора
        Action: {

          // Генерація ідентифікатора
          GenerateID: function () {
            return (Math.random() * 100000).toFixed(0);
          }
        },

        // TinyMCE конфігурація
        TinyMCE: {

          // Ініціалізація TinyMCE для вибраного типу блоку
          Init: function (Type) {
            var config = Article.TinyMCE[Type];

            var prefix = ".la-container--id" + Article.ID + " ";
            if(config.selector && config.selector.indexOf(prefix) !== 0) {
              config.selector = prefix + config.selector;
              // console.log('l#49', config.selector);
            }
            tinymce.init($.extend({}, Article.TinyMCE.Global, Article.TinyMCE[Type]));
          },

          // Ініціалізація усіх блоків TinyMCE
          InitOnStart: function () {

            for (var value in Article.TinyMCE) {

              if (value === 'Init' || value === 'InitOnStart' || value === 'Global') continue;

              Article.TinyMCE.Init(value);
            }
          },

          // Глобальні налаштування TinyMCE
          Global: {

            language: 'ru',

            inline: true,
            menubar: false,
            paste_as_text: true,
            gecko_spellcheck:true,
            browser_spellcheck: true,
            toolbar_items_size: 'small',
            fontsize_formats: "8px 10px 12px 14px 16px 18px 20px 24px 28px 32px 36px 40px 44px 48px 52px 56px 60px 64px 68px 72px",
            font_formats: "Andale Mono=andale mono,times;"+
                    "Arial=arial,helvetica,sans-serif;"+
                    "Arial Black=arial black,avant garde;"+
                    "Book Antiqua=book antiqua,palatino;"+
                    "Comic Sans MS=comic sans ms,sans-serif;"+
                    "Courier New=courier new,courier;"+
                    "Georgia=georgia,palatino;"+
                    "Helvetica=helvetica, sans-serif;"+
                    "Impact=impact,chicago;"+
                    "Symbol=symbol;"+
                    "Tahoma=tahoma,arial,helvetica,sans-serif;"+
                    "Terminal=terminal,monaco;"+
                    "Times New Roman=times new roman,times;"+
                    "Trebuchet MS=trebuchet ms,geneva;"+
                    "Verdana=verdana,geneva;"+
                    "Webdings=webdings;"+
                    "Wingdings=wingdings,zapf dingbats",

            setup: function (editor) {
              // Втрата фокусу блоком TinyMCE
              editor.on('blur', function (e) {
                //console.log('l#92', e, Article);
                // Article.SaveContent(); vsv
                $('.js-mobile-header-save-btn').fadeIn();
                $('.js-save-btn').fadeIn();
                $('.js-mobile-header-saved').hide();
                $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
              });

              // Фокус блоку TinyMCE
              editor.on('focus', function () {
                //console.log('l#97');
                //
              });
            }
          },

          // TinyMCE для поля Заголовок
          Header: {
            selector: ".la-block-content__editable--header",
            plugins: ["link heading paste charmap textcolor"],
            toolbar: "undo redo | link h1 h2 h3 | fontselect fontsizeselect | bold italic underline strikethrough | alignleft aligncenter alignright | forecolor backcolor"
          },

          // TinyMCE для поля Текстовий блок
          Text: {
            selector: ".la-block-content__editable--text",
            plugins: ["link paste advlist textcolor charmap"],
            toolbar: "undo redo | link bold italic underline strikethrough | fontselect fontsizeselect | alignleft aligncenter alignright alignjustify | superscript subscript | outdent indent | charmap | forecolor backcolor"
          },

          // TinyMCE для поля Список
          List: {
            selector: ".la-block-content__editable--list",
            plugins: ["link paste advlist lists textcolor charmap"],
            toolbar: "undo redo | link bold italic underline strikethrough | fontselect fontsizeselect | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | superscript subscript | charmap | forecolor backcolor"
          },

          // TinyMCE для поля Відео
          Media: {
            selector: ".la-block-content__editable--media",
            plugins: ["link media"],
            toolbar: "link media"
          },

          // TinyMCE для поля Таблиця
          Table: {
            selector: ".la-block-content__editable--table",
            visual_table_class: "table table-bordered",
            plugins: ["link paste textcolor table contextmenu"],
            toolbar: "undo redo | link bold italic underline strikethrough | fontselect fontsizeselect | alignleft aligncenter alignright alignjustify | superscript subscript | forecolor backcolor | table",
          },

          // TinyMCE для поля Цитата
          Cite: {
            selector: ".la-block-content__editable--cite",
            plugins: ["link paste advlist textcolor charmap"],
            toolbar: "undo redo | link bold italic underline strikethrough | fontselect fontsizeselect | alignleft aligncenter alignright alignjustify | superscript subscript | charmap | forecolor backcolor"
          },

          // TinyMCE для поля Зображення
          Image: {
            //
          },

          // TinyMCE для поля Довільний HTML
          Html: {
            //
          }
        },

        // Шаблони
        Template: {

          // Контейнер редактора
          Container: function () {
            var html = '';
            html += '<div class="lb-container">';
            html += '<div class="lb-row">';
            html += '<div class="col-sm-offset-2 col-sm-10 la-container la-container-start-control la-container-start-control--id' + Article.ID + '">';
            html += '<button type="button" class="btn btn-success la-add-content-template__button" data-toggle="modal" data-target="#templateModal'+textareaId+'" data-whatever="Template">Использовать шаблон</button>';
            html += '<button type="button" class="btn btn-success la-create-content-template__button" data-toggle="modal" data-target="#createTemplateModal" data-whatever="createTemplate">Создать шаблон</button>';
            html += '<button type="button" class="btn btn-primary la-add-content-block__button">Добавить секцию с контентом</button>';
            html += '<button type="button" class="btn btn-default la-copy-content__button" title="Копировать"><i class="material-icons ic_content_copy"></i></button>';
            html += '<button type="button" class="btn btn-default la-insert-content__button" title="Вставить"><i class="material-icons ic_content_paste"></i></button>';
            html += '</div>';
            html += '<div class="lb-col-sm-12 la-container la-container-content la-container--id' + Article.ID + '"></div>';
            html += '<div class="lb-col-sm-12 la-prehtml la-prehtml--id' + Article.ID + '"></div>';
            html += '</div>';
            html += '</div>';
            return html;
          },

          // Секція статті
          Section: function (id) {
            var html = '';
            html += '<div class="lb-row la-section-row">';
            html += '<div class="lb-col-sm-12 la-section la-section--empty la-section--id' + id + '" data-active-grid="12">';
            html += '<div class="lb-row">';
            html += '<div class="lb-col-sm-12 la-grid">';
            html += '<div class="lb-row">';
            html += Article.Template.Grid(Article.Config.DefaultGrid);
            html += '</div>';
            html += '</div>';
            html += Article.Template.Toolbar();
            html += '</div>';
            html += '</div>';
            html += '</div>';
            return html;
          },

          // Секція статті у сітці
          SectionGrid: function (id) {
            var html = '';
            html += '<div class="lb-row">';
            html += Article.Template.BlockGrid(id)
            html += '</div>';
            return html;
          },

          // Генерація сітки
          Grid: function (Type, Block) {

            if (typeof Type !== 'string' || Type.search(/\-/) < 0) {
              Type = [12];
            } else {
              Type = Type.split('-');
            }

            var html = '';

            for (var i = 0; i < Type.length; i++) {
              html += '<div class="lb-col-sm-' + Type[i] + ' grid-block">';
              html += '<div class="lb-row grid-block-row">';
              html += Block ? (Block[i] ? Block[i] : Article.Template.Block()) : Article.Template.Block();
              html += '</div>';
              html += '</div>';
            }

            return html;
          },

          NewGrid: function (Type, Block) {

            if (typeof Type !== 'string' || Type.search(/\-/) < 0) {
              Type = [12];
            } else {
              Type = Type.split('-');
            }

            var html = '';

            for (var i = 0; i < Type.length; i++) {
              html += '<div class="lb-col-sm-' + Type[i] + ' grid-block">';
              html += Block ? (Block[i] ? Block[i] : Article.Template.NewBlock()) : Article.Template.NewBlock();
              html += '</div>';
            }

            return html;
          },

          // Блок статті
          Block: function () {
            var html = '';
            html += '<div class="lb-col-sm-12 la-block la-block--empty la-block--noactive la-block--id' + Article.Action.GenerateID() + '">';
            html += '<div class="la-block-content"></div>';
            html += Article.Template.Categories();
            html += Article.Template.Plus();
            html += Article.Template.Menu();
            html += '</div>';
            return html;
          },

          NewBlock: function () {
            var html = '';
            html += '<div class="lb-row">';
            html += '<div class="lb-col-sm-12 la-block la-block--empty la-block--noactive la-block--id' + Article.Action.GenerateID() + '">';
            html += '<div class="la-block-content"></div>';
            html += Article.Template.Categories();
            html += Article.Template.PlusBlock();
            html += Article.Template.Menu();
            html += '</div>';
            html += '</div>';
            return html;
          },

          // Блок статті у сітці
          BlockGrid: function (id) {
            var html = '';
            html += '<div class="lb-col-sm-12 la-block la-block--empty la-block--noactive la-block--id' + id + '">';
            html += '<div class="la-block-content"></div>';
            html += Article.Template.Categories();
            html += Article.Template.PlusBlock();
            html += Article.Template.Menu();
            html += '</div>';
            return html;
          },

          // Меню вибору типу блоку
          Categories: function () {
            var html = '';
            html += '<div class="la-block-categories">';
            html += '<button type="button" class="btn btn-sm btn-default la-block-categories-btns-toggle" title="Редактировать"><i class="material-icons ic_mode_edit"></i></button>';
            html += '<div class="la-block-categories-btns">';
            html += '<button type="button" class="btn btn-sm btn-default la-block-insert__button" title="Вставить"><i class="material-icons ic_content_paste"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-block-categories__button" data-category="Header" title="Заголовок"><i class="material-icons ic_title"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-block-categories__button" data-category="Text" title="Текст"><i class="material-icons ic_format_color_text"></i></span></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-block-categories__button" data-category="List" title="Список"><i class="material-icons ic_format_list_bulleted"></i></button>';

            if (Article.Storage.Textarea.attr('data-attachment-url')) {
              html += '<button type="button" class="btn btn-sm btn-default la-block-categories__button" data-category="Image" title="Изображение"><i class="material-icons ic_photo_size_select_actual"></i></button>';
            }

            // html += '<button type="button" class="btn btn-default la-block-categories__button" data-category="Media" title="Видео"><span class="glyphicon glyphicon-film"></span></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-block-categories__button" data-category="Table" title="Таблица"><i class="material-icons ic_border_all"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-block-categories__button" data-category="Cite" title="Цитата"><i class="material-icons ic_format_quote"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-block-tag__button" title="Tag" data-toggle="modal" data-target="#tagsModal" data-whatever="Tags"><i class="material-icons ic_extension"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-block-categories__button" data-category="Html" title="HTML"><i class="material-icons ic_code"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-block-settings__button" title="Настройки"><i class="material-icons ic_settings"></i></button>';
            html += '</div>';
            html += '</div>';
            return html;
          },

          // Кнопка "Добавить секцию с контентом" для блоку
          Plus: function () {
            var html = '';
            html += '<div class="la-block-plus la-block-plus-section">';
            html += '<button type="button" class="btn add-section btn-primary la-block-plus__button" data-toggle="modal" data-target="#gridModal" data-whatever="Grid" title="Добавить секцию"><i class="material-icons ic_add_circle"></i> Добавить секцию с контентом</span></button>';
            html += '</div>';
            return html;
          },

          // Кнопка "+" для блоку
          PlusBlock: function () {
            var html = '';
            html += '<div class="la-block-plus la-block-plus-block">';
            html += '<button type="button" class="btn btn-link btn-link-success la-block-plus__btn" title="Добавить блок"><i class="material-icons ic_add_circle"></i></button>';
            html += '</div>';
            return html;
          },

          // Меню блоку
          Menu: function () {
            var id = randomString(8);
            var html = '';
            html += '<div class="la-block-menu">';
            html += '<div class="la-block-menu__confirm">';
            html += '<button type="button" class="btn btn-success btn-sm la-block-menu__button la-block-menu__button--ok"><span class="glyphicon glyphicon-ok"></span></button>';
            html += '<button type="button" class="btn btn-danger btn-sm la-block-menu__button la-block-menu__button--cancel"><span class="glyphicon glyphicon-remove"></span></button>';
            html += '</div>';
            html += '<div class="la-block-menu__operations">';
            html += '<div class="la-block-menu__operations-btns">';
            // html += '<button type="button" class="btn btn-default btn-sm la-block-menu__button la-block-menu__button--resize"><span class="glyphicon glyphicon-resize-vertical"></span></button>';
            html += '<button type="button" class="btn btn-default btn-sm la-block-menu__button la-block-menu__button--copy" title="Копировать"><i class="material-icons ic_content_copy"></i></button>';
            html += '<button type="button" class="btn btn-default btn-sm la-block-menu__button la-block-menu__button--insert" title="Вставить"><i class="material-icons ic_content_paste"></i></button>';
            html += '<button type="button" class="btn btn-default btn-sm la-block-menu__button la-block-menu__button--remove" title="Удалить"><i class="material-icons ic_delete"></i></button>';
            html += '<button type="button" class="btn btn-default btn-sm la-block-menu__button la-block-menu__button--class-toggle" data-toggle="modal" data-target="#classModal" data-whatever="Class" title="Class"><i class="material-icons ic_style"></i></button>';
            html += '<button type="button" class="btn btn-default btn-sm la-block-menu__button la-block-menu__button--bgcolor" title="Фоновый цвет"><i class="material-icons ic_format_color_fill"></i></button>';
            html += '<button type="button" class="btn btn-default btn-sm la-block-menu__button la-block-menu__button--bgimg" title="Фоновая картинка"><i class="material-icons ic_photo_size_select_actual"></i></button>';
            html += '<input class="file-manager-button" url="' + Article.Storage.Textarea.attr('data-attachment-url') + '" id="' + id +'" type="hidden" ' + 'value="' + Article.Storage.Textarea.attr('id') + '" name="' + id +'" data-toggle="fileManager" data-url="' + Article.Storage.Textarea.attr('data-attachment-url') + '" data-control=".' + id +'"/>';
            html += '<div class="d-none background-image img-list file-manager-control ' + id +'">';
            html += '</div>';
            html += '<button type="button" class="btn btn-default btn-sm la-block-menu__button la-block-menu__button--changetype hide" title="Изменить тип"><i class="material-icons ic_mode_edit"></i></button>';
            html += '<button type="button" class="btn btn-default btn-sm la-block-menu__button la-block-menu__button--hide" title="Скрыть/Показать"><i class="material-icons ic_visibility" data-change-icon="ic_visibility_off"></i></button>';
            html += '<button type="button" class="btn btn-default btn-sm la-block-menu__button la-block-menu__button--move" title="Переместить"><i class="material-icons ic_zoom_out_map"></i></button>';
            html += '<button type="button" class="btn btn-default btn-sm la-block-menu__button la-block-menu__button--setting" title="Выбор типа блока"><i class="material-icons ic_settings"></i></button>';
            html += '</div>';
            html += '<button type="button" class="btn btn-default btn-sm la-block-menu__button la-block-menu__button--toggle-menu" title="Настройки"><i class="material-icons ic_settings"></i></button>';
            html += '</div>';
            html += '</div>';
            id = '';
            return html;
          },
          
          // Панель операцій секції
          Toolbar: function () {
            var id = randomString(8);
            var html = '';
            html += '<div class="la-toolbar">';
            html += '<button class="btn btn-sm btn-default la-toolbar__button--toggle"><i class="material-icons ic_settings" title="Настройки"></i></button>';
            html += '<div class="la-toolbar__area--toggle" style="display: none;">';
            html += '<div class="btn-group">';
            html += '<button type="button" class="btn btn-sm btn-default la-toolbar__button la-toolbar__button--id-toggle" data-toggle="modal" data-target="#idModal" data-whatever="ID" title="id"><i class="material-icons ic_bookmark"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-toolbar__button la-toolbar__button--class-toggle" data-toggle="modal" data-target="#classModal" data-whatever="Class" title="Class"><i class="material-icons ic_style"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-toolbar__button la-toolbar__button--changegrid" data-toggle="modal" data-target="#gridModal" data-whatever="ChangeGrid" title="Изменить сетку"><i class="material-icons ic_view_column"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-toolbar__button la-toolbar__button--bgcolor" title="Фоновый цвет"><i class="material-icons ic_format_color_fill"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-toolbar__button la-toolbar__button--bgimage" title="Фоновая картинка"><i class="material-icons ic_photo_size_select_actual"></i></button>';
            // html += '<input type="hidden" class="attachment-ajax" url="' + Article.Storage.Textarea.attr('data-attachment-url') + '" name="" value="" />';
            html += '<input class="file-manager-button" url="' + Article.Storage.Textarea.attr('data-attachment-url') + '" id="' + id +'" type="hidden" ' + 'value="' + Article.Storage.Textarea.attr('id') + '" name="' + id +'" data-toggle="fileManager" data-url="' + Article.Storage.Textarea.attr('data-attachment-url') + '" data-control=".' + id +'"/>';
            html += '<div class="d-none background-image img-list file-manager-control ' + id +'">';
            html += '</div>';
            html += '<button type="button" class="btn btn-sm btn-default la-toolbar__button la-toolbar__button--header" title="На вылет"><i class="material-icons ic_all_inclusive"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-toolbar__button la-toolbar__button--copy" title="Копировать"><i class="material-icons ic_content_copy"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-toolbar__button la-toolbar__button--insert" title="Вставить"><i class="material-icons ic_content_paste"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-toolbar__button la-toolbar__button--clear" title="Удалить фон"><i class="material-icons ic_cached"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-toolbar__button la-toolbar__button--remove" title="Удалить"><i class="material-icons ic_delete"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-toolbar__button la-toolbar__button--hide" title="Скрыть/Показать"><i class="material-icons ic_visibility"></i></button>';
            html += '<button type="button" class="btn btn-sm btn-default la-toolbar__button la-toolbar__button--move" title="Переместить"><i class="material-icons ic_zoom_out_map"></i></button>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            id = "";
            return html;
          },

          // Html-блок
          HtmlBlock: function (Load) {
            var html = '';

            if (!Load) {
              html += '<div class="la-block-content__htmlsaver"></div>';
            }

            html += '<textarea class="la-block-content__htmlarea"></textarea>';
            html += '<button type="button" class="btn btn-default la-block-content__htmlpreview" title="Показать код"><span class="glyphicon glyphicon-eye-close"></span></button>';
            return html;
          },

          // Image-блок
          ImageBlock: function () {
            var id = randomString(8);
            var html = '';
            html = '<div class="la-control clearfix">';
            html += '<input class="file-manager-button" multiple="multiple" id="' + id +'" type="hidden" ' + 'value="' + Article.Storage.Textarea.attr('id') + '" name="' + id +'" data-toggle="fileManager" data-url="' + Article.Storage.Textarea.attr('data-attachment-url') + '" data-control=".' + id +'"/>';
            html += '<div class="la-control__right">';
            html += '<button class="btn btn-sm btn-default slider" title="Слайдер"><i class="material-icons ic_burst_mode"></i></button>';
            html += '<button class="btn btn-sm btn-default gallery" title="Галерея"><i class="material-icons ic_photo_size_select_actual"></i></button>';
            html += '<button class="btn btn-sm btn-default preview" title="Превью"><i class="material-icons ic_view_compact"></i></button>';
            html += '</div>';
            html += '</div>';
            html += '<div class="la-block-add-image clearfix">';
            html += '<div class="btn btn-sm btn-warning btn-add-image"><i class="material-icons ic_add_a_photo"></i><span>Загрузить фото</span></div>'
            html += '</div>';
            html += '<div class="img-list-wrapper">';
            html += '<ul class="img-list file-manager-control ' + id +'">';
            html += '</ul>';
            html += '</div>';
            id = "";
            return html;
          }
        },

        // Додаткові функції для блоків при створенні
        BlockCustom: {

          Header: function (Block, Load) {
            Block.append(
              '<div class="la-block-content__setting--header">'+
                '<div class="btn btn-sm btn-default la-block-content__setting--header-btn" data-header="h1">H1</div>'+
                '<div class="btn btn-sm btn-default la-block-content__setting--header-btn" data-header="h2">H2</div>'+
                '<div class="btn btn-sm btn-default la-block-content__setting--header-btn" data-header="h3">H3</div>'+
              '</div>'
            );

            Block.find('.la-block-content').hide();
            Block.addClass('la-block--empty');

            Block.on('click', '.la-block-content__setting--header-btn', function () {

              if ($(this).data('header') == 'h1') {
                Block.find('.la-block-content .la-block-content__editable--header').html('<h1><br data-mce-bogus="1"></h1>');
              } else if ($(this).data('header') == 'h2') {
                Block.find('.la-block-content .la-block-content__editable--header').html('<h2><br data-mce-bogus="1"></h2>');
              } else {
                Block.find('.la-block-content .la-block-content__editable--header').html('<h3><br data-mce-bogus="1"></h3>');
              }

              $(this).closest('.la-block-content__setting--header').remove();
              Block.find('.la-block-content').show();
              Block.removeClass('la-block--empty');

            });
          },

          // Додаткові функції для HTML-блоку
          Html: function (Block, Load) {

            // При зміні контенту html-блоку, зберігати його до сховища
            Block.find('.la-block-content__htmlarea').on('blur', function () {
              $(this).siblings('.la-block-content__htmlsaver').html($(this).val());

              //console.log('l#336');
              // Article.SaveContent(Block.closest('.la-section')); vsv
              $('.js-mobile-header-save-btn').fadeIn();
              $('.js-save-btn').fadeIn();
              $('.js-mobile-header-saved').hide();
              $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
            });

            // Кнопка попереднього перегляду html-блоку
            Block.on('click', '.la-block-content__htmlpreview', function () {

              var $span = $(this).find('span');

              if ($span.hasClass('glyphicon-eye-close')) {

                $span.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');

                Block.find('.la-block-content__htmlarea').hide().siblings('.la-block-content__htmlsaver').show();

              } else {

                $span.removeClass('glyphicon-eye-open').addClass('glyphicon-eye-close');

                Block.find('.la-block-content__htmlsaver').hide().siblings('.la-block-content__htmlarea').show();
              }
            });

            // При завантаженні редактора
            if (Load) {
              Block.find('.la-block-content__htmlpreview').trigger('click');
            }
          },

          // Додаткові функції для блоку Зображення
          Image: function (Block, Value) {

            // Видалити зайві класи перед активацією плагіна завантаження зображень
            Block.find('.file-btn').remove().find('.add-logo-photo').remove();

            if (Value) {
              Block.find('.la-block-content .file-manager-button').val(Value);
            }

            // Активувати плагін завантаження зображень
            Block.find('.la-block-content .file-manager-button').fileManager('init');
            //Block.find('.attachment-img').addClass('text-right').prepend('<div class="btn btn-sm btn-warning btn-add-img"><i class="material-icons ic_add_a_photo"></i></div>');

            // Активувати потрібну кнопку вибору типу блоку Зображення на початку
            Block.find('.img-list-wrapper').each(function () {

              var $elem = $(this);

              if ($elem.hasClass('img-slider')) {
                Block.find('button.slider').removeClass('btn-default').addClass('btn-primary');
              } else if ($elem.hasClass('img-preview')) {
                Block.find('button.preview').removeClass('btn-default').addClass('btn-primary');
              } else if ($elem.hasClass('img-gallery')) {
                Block.find('button.gallery').removeClass('btn-default').addClass('btn-primary');
              }
            });

            // Вибрати Slider
            Block.on('click', 'button.slider', function (event) {
              event.preventDefault();
              $(this).parent().find('button.btn-primary').removeClass('btn-primary').addClass('btn-default');
              $(this).addClass('btn-primary').closest('.la-block').find('.img-list-wrapper').addClass('img-slider').removeClass('img-preview img-gallery');
              //console.log('l#408');
              // Article.SaveContent(Block.closest('.la-section')); vsv
              $('.js-mobile-header-save-btn').fadeIn();
              $('.js-save-btn').fadeIn();
              $('.js-mobile-header-saved').hide();
              $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
            });

            // Вибрати Preview
            Block.on('click', 'button.preview', function (event) {
              event.preventDefault();

              $(this).parent().find('button.btn-primary').removeClass('btn-primary').addClass('btn-default');
              $(this).addClass('btn-primary').closest('.la-block').find('.img-list-wrapper').addClass('img-preview').removeClass('img-slider img-gallery');
              //console.log('l#419');
              // Article.SaveContent(Block.closest('.la-section')); vsv
              $('.js-mobile-header-save-btn').fadeIn();
              $('.js-save-btn').fadeIn();
              $('.js-mobile-header-saved').hide();
              $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
            });

            // Вибрати Gallery
            Block.on('click', 'button.gallery', function (event) {
              event.preventDefault();

              $(this).parent().find('button.btn-primary').removeClass('btn-primary').addClass('btn-default');
              $(this).addClass('btn-primary').closest('.la-block').find('.img-list-wrapper').addClass('img-gallery').removeClass('img-slider img-preview');
              //console.log('l#430');
              // Article.SaveContent(Block.closest('.la-section')); vsv
              $('.js-mobile-header-save-btn').fadeIn();
              $('.js-save-btn').fadeIn();
              $('.js-mobile-header-saved').hide();
              $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
            });

            // Для вікна вибору зображень
            $(document.body).on('change', '.lb-container input.file-manager-button', function (e) {
              var ids = $(this).val().split(',');
              var $container = $(this).closest('.la-block-content__editable');
              var $popup = $(this).data('$button').data('$popup');
              var languageCode = $(this).closest('.js-l-selectee').attr('code');
              var $imgListWrapperClass =  $container.find('.img-list-wrapper').hasClass('img-gallery') ? 'img-gallery' : $container.find('.img-list-wrapper').hasClass('img-slider') ? 'img-slider' : 'img-preview';
              $container.find('.img-list-wrapper').remove();
              var $list = $('<div class="img-list-wrapper '+$imgListWrapperClass+'"><ul class="img-list"></ul></div>').appendTo($container).find('.img-list');
              //  idk what it was done for
              // $container.find('.img-list-wrapper .img-list').remove();
              // $('<ul class="img-list"></ul>').appendTo($container.find('.img-list-wrapper'));
              // var $list = $container.find('.img-list');
              // 

              ids.length ? $container.removeClass('la-no-image') : $container.addClass('la-no-image');
             
              $.each(ids, function (index, id) {
                var href = $popup.find('.attachment[attachment-file-id=' + id + ']').data('href');
                var $li = $('<li></li>').appendTo($list);
                var $img = $popup.find('.attachment[attachment-file-id=' + id + '] img').clone().attr('fileid', id);
                var absolute = /^https?:\/\//i.test(href);

                if (href) {
                    if (absolute) {
                        $('<a href="' + href + '" target="_blank"></a>').append($img).appendTo($li);
                    } else {
                        $('<a href="' + href + '"></a>').append($img).appendTo($li);
                    }
                } else {
                     $img.appendTo($li);
                }

                $li.append('<a href="#edit-photo-' + id + '" class="la-block-image-text-button edit-photo-btn" title="Описание изображения" la-image-file-id="' + id + '"><span class="material-icons ic_mode_edit"></span></a>');
                
                $li.wrapInner('<div class="la-image-container"></div>');

                var description = false;
                if (languageCode) {
                    description = $popup.find('.attachment[attachment-file-id=' + id + '] .js-photo-description-' + languageCode).val();
                } else {
                    description = $popup.find('.attachment[attachment-file-id=' + id + '] .js-photo-description:first').val();
                }
                
                $('<div class="img-description"></div>').text(description).appendTo($li);
              });

              //console.log('l#448');
              // Article.SaveContent(Block.closest('.la-section')); vsv
              $('.js-mobile-header-save-btn').fadeIn();
              $('.js-save-btn').fadeIn();
              $('.js-mobile-header-saved').hide();
              $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
            });
          }
        },

        // Ініціалізація редактора
        Init: function (Textarea) {

          // Згенерувати доступні сітки
          var html = '';
          // html += '<li class="another-grid-wrp">';
          // html += '<input type="text" class="another-grid" placeholder="Свой вариант">';
          // html += '<span class="another-grid-btn">ok</span>';
          // html += '</li>';
          for (var i = 0; i < Article.Config.AllowGrids.length; i++) {
            var htmlBlock = '';
            var gridVariant = Article.Config.AllowGrids[i].split('-');
            htmlBlock += '<div class="la-toolbar__grid--button clearfix">';
            for (var j = 0; j < gridVariant.length; j++) {
              htmlBlock += '<div class="la-toolbar__grid--butcol"></div>';
              if (j + 1 < gridVariant.length) {
                htmlBlock += '<div class="la-toolbar__grid--butsep"></div>';
              }
            }
            htmlBlock += '</div>';
            html += '<div class="col-sm-2 grid-item"><a href="#" data-grid="' + Article.Config.AllowGrids[i] + '" style="display: block; color: #5C6982; text-align: center;">' + htmlBlock + '&nbsp;' + Article.Config.AllowGrids[i] + '</a></div>';
          }

          // Зберегти список сіток у toolbar
          $('#gridModal .grid-menu').html(html);

          // Встановити розміри блоків сітки у списку вибору
          $('.la-toolbar__grid--button').each(function (index) {
            var $elem = $(this);

            var gridVariant = Article.Config.AllowGrids[index].split('-');

            var $columns = $elem.find('.la-toolbar__grid--butcol');
            var $separs = $elem.find('.la-toolbar__grid--butsep');
            var buttonWidth = $('.la-toolbar__grid--button').width();
            var separWidth = $('.la-toolbar__grid--butsep').width();
            var columns = $columns.length;
            var columnLenght = (buttonWidth - separWidth * (columns - 1)) / 12;

            $columns.each(function (index) {
              $(this).width(gridVariant[index] * columnLenght);
            });
          });

          // Згенерувати ідентифікатор контейнера редактора
          Article.ID = Article.Action.GenerateID();

          // Створити контейнер для поточного редактора
          $(Article.Config.Placeholder).after(Article.Template.Container());

          // Додати ідентифікатор до поточної textarea
          Textarea.addClass('la-textarea la-textarea--id' + Article.ID);

          // Збереження посилання на поточну ініціалізовану textarea редактора
          Article.Storage.Textarea = Textarea;

          // Зберегти посилання на поточне сховище для попередньої обробки контенту статті перед віправкою на сервер
          Article.Storage.Prehtml = $('.la-prehtml--id' + Article.ID);

          // Збереження посилання на поточний контейнер редактора
          Article.Storage.Container = $('.la-container--id' + Article.ID);

          // Збереження посилання на поточний контейнер стартовий налаштувань редактора
          Article.Storage.ContainerControl = $('.la-container-start-control--id' + Article.ID);

          // Перевірка існування контенту статті
          if (Article.Storage.Textarea.val() !== '') {

            // Закинути контент статті в контейнер
            Article.Storage.Container.html(Article.Storage.Textarea.val());

            var Sections = Article.Storage.Container.find('.la-section');

            // Если нету ниодной секции, скорее всего это текст из старого редактора
            // Поместить в CustomBlock
            if (!Sections.length) {
              Article.Storage.Container.html('<div class="lb-row"><div class="lb-col-sm-12 la-section la-section--id' + Article.Action.GenerateID() + '"><div class="lb-row"><div class="lb-col-sm-12 la-grid"><div class="lb-row"><div class="lb-col-sm-12"><div class="lb-row"><div class="lb-col-sm-12 la-block la-block--id' + Article.Action.GenerateID() + '"><div class="la-block-content" style="display: block;"><div class="la-block-content__editable la-block-content__editable--html" data-type="Html"><div class="la-block-content__htmlsaver" style="display: block;">' + Article.Storage.Container.html() + '</div></div></div></div></div></div></div></div></div></div></div>');
            }

            Article.Storage.Container.find('.la-grid > .lb-row .grid-block > .lb-row').addClass('grid-block-row');
            Article.Storage.Container.find('.la-section').parent().addClass('la-section-row');

            // Ініціалізувати усі секції статті
            Article.Storage.Container.find('.la-section').each(function () {
              Article.LinkyArticleSection($(this));
            });

            // Добавити проміжні пусті секції
            Article.Storage.Container.find('.la-section').each(function (index) {
              if (index === 0) {
                Article.AddSection('Before', $(this));
                Article.AddSection('After', $(this));
              } else {
                Article.AddSection('After', $(this));
              }
            });

            // Добавити клас для блоків сітки, якщо його немає (був створений попередньою версією редактора)
            Article.Storage.Container.find('.la-grid > .lb-row > div').each(function () {
              if(!$(this).hasClass('grid-block')) {
                $(this).addClass('grid-block');
              }
            });

            // Добавити проміжні пусті блоки у сітці
            Article.Storage.Container.find('.grid-block').each(function () {
              $(this).find($('.la-block:not(.la-block--empty)')).each(function (index) {
                if (index === 0) {
                  Article.AddSectionGrid('Before', $(this));
                  Article.AddSectionGrid('After', $(this));
                } else {
                  Article.AddSectionGrid('After', $(this));
                }
              });
            });

            // Ініціалізувати усі блоки TinyMCE
            Article.TinyMCE.InitOnStart();

          } else {

            // Додати секцію, якщо поле контенту статті пусте
            Article.AddSection('Append');
          }

          // Тимчасова функція для застосування нового тулбару (!!! Видалити через деякий час)
          // $('.la-toolbar').removeClass('lb-col-sm-2 lb-col-sm-3').addClass('lb-col-sm-1');
          $('.la-grid').removeClass('lb-col-sm-9 lb-col-sm-10 lb-col-sm-11 la-header').addClass('lb-col-sm-12');

          // Зробити кнопки широких секцій активними
          Article.Storage.Container.find('.la-section--fullWidth').each(function () {
            $(this).find('.la-toolbar__button--header').addClass('active');
          });

          // Сортування секцій
          Article.Storage.Container.sortable({
            handle: ".la-toolbar__button--move",
            start: function( event, ui ) {
              // Додати клас боді
              $('body').addClass('dragging_section');

              // Видалити пусті секції
              Article.Storage.Container.find('.la-section--empty').parent().remove();
            },
            stop: function( event, ui ) {
              // Видалити клас боді
              $('body').removeClass('dragging_section');

              // Добавити проміжні пусті секції
              Article.Storage.Container.find('.la-section').each(function (index) {
                if (index === 0) {
                  Article.AddSection('Before', $(this));
                  Article.AddSection('After', $(this));
                } else {
                  Article.AddSection('After', $(this));
                }
              });
            }
          });

          // Копіювання контенту редактора
          Article.Storage.ContainerControl.find('.la-copy-content__button').on('click', function() {
            var activeContainer = $(this).closest('.lb-container').find('.la-container-content'),
                ContaineContent = $(this).closest('.lb-container').find('.la-container-content').html();
            $.ajax({
              url: '/admin/ajax/buffer.htm',
              data: {
                key: 'redactorContent',
                data: ContaineContent,
                data2: 'dgsdgsh',
                somedata: 21423532,
                abc: '3teterg'
              },
              dataType: 'jsonp',
              method: 'POST',
              success: function (data) {
                console.log(data);
                //data.error - сообщение об ошибке, если оно есть значит буфер не сохранен
                
                $('body').removeClass('no-copy-page');

              }
            });
          });

          // Вставка контенту редактора
          Article.Storage.ContainerControl.find('.la-insert-content__button').on('click', function() {
            var activeContainer = $(this).closest('.lb-container').find('.la-container-content');
            $.ajax({
              url: '/admin/ajax/buffer.htm',
              data: {
                key: 'redactorContent',
              },
              dataType: 'jsonp',
              method: 'GET',
              success: function (data) {
                activeContainer.html(data.data);
                activeContainer.find('.la-section').each( function () {
                  console.log($(this));
                  // Article.SaveContent($(this)); vsv
                  $('.js-mobile-header-save-btn').fadeIn();
                  $('.js-save-btn').fadeIn();
                  $('.js-mobile-header-saved').hide();
                  $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
                });
                activeContainer.closest('form').find('[type="submit"]').trigger('click');
              }
            });
          });

          // Кнопка створення першого блоку з контентом
          Article.Storage.ContainerControl.find('.la-add-content-block__button').on('click', function() {
            $(this).closest('.lb-container').find('.la-container-content > .lb-row:first-child .la-section .la-block-plus__button').trigger('click');
          });

          // Кнопка показу вікна створення шаблону
          Article.Storage.ContainerControl.find('.la-create-content-template__button').on('click', function() {
            $('#createTemplateModal').data('templateContentUrl', $(this).closest('.lb-container').siblings('textarea').attr('data-template-content-url'));
          });

          // Перевірка наявності блоку з контентом
          Article.Storage.ContainerControl.closest('.lb-container').find('.la-container-content .la-section:not(.la-section--empty)').length ? Article.Storage.ContainerControl.closest('.lb-container').addClass('has-content') : Article.Storage.ContainerControl.closest('.lb-container').addClass('no-content');

          // Сортування блоків
          $('.la-grid > .lb-row .grid-block').sortable({
            handle: ".la-block-menu__button--move",
            start: function( event, ui ) {
              // Додати клас боді
              $('body').addClass('dragging_block');

              // Додати клас блоку
              $(ui.helper).closest('.grid-block').addClass('dragged_block');

              // Видалити пусті блоки
              $(ui.helper).closest('.grid-block').find('.la-block--empty').parent().remove();
            },
            stop: function( event, ui ) {
              // Видалити клас боді
              $('body').removeClass('dragging_block');

              // Добавити проміжні пусті блоки у сітці
              $('.grid-block.dragged_block').find($('.la-block:not(.la-block--empty)')).each(function (index) {
                if (index === 0) {
                  Article.AddSectionGrid('Before', $(this));
                  Article.AddSectionGrid('After', $(this));
                } else {
                  Article.AddSectionGrid('After', $(this));
                }
              });

              // Видалити клас блока
              $('.grid-block.dragged_block').removeClass('dragged_block');
            }
          });
        },

        // Закинути готовий контент статті назад у textarea для відправки на сервер
        SaveContent: function ($Section) {
          //console.log('Saved!');
          Article.Storage.Container.find('.la-toolbar__area--toggle').hide().siblings('.la-toolbar__button--toggle').removeClass('btn-primary');

          // Закинути контент статті в сховище для попередньої обробки перед збереженням
          Article.Storage.Prehtml.html(Article.Storage.Container.html());

          // Видалити пусті секції
          $('.la-section', Article.Storage.Prehtml).each(function () {

            if ($(this).hasClass('la-section--empty')) {
              $(this).parent().remove();
            } else {

              $(this).removeClass('data-active-grid');

              var count = 0;
              $('.la-block', $(this)).each(function () {

                if (!$(this).hasClass('la-block--empty')) {
                  count++;
                }

              });

              $('.grid-block', $(this)).each(function () {
                if ($(this).find($('.la-block:not(.la-block--empty)')).length) {
                  $(this).find($('.la-block--empty')).each(function() {
                    $(this).parent().remove();
                  });
                } else {
                  $(this).find($('.la-block--empty')).each(function(index) {
                    if (index == 0) return;
                    $(this).parent().remove();
                  });
                }
              });

              if (count === 0) {
                $(this).parent().remove();
              }

              $('input[name^="mce_"]').remove();
            }
          });

          

          // Видалити зайві блоки
          $('.la-block-plus, .la-block-menu, .la-block-categories, .la-toolbar, .la-block-content__htmlarea, .la-block-content__htmlpreview, .la-control, .tag-control, .tag-title, .tag-image, .edit-photo-btn, .la-block-add-image', Article.Storage.Prehtml).remove();

          // Видалити зайвий блок у фото
          $('.la-image-container > *:first-child').unwrap();

          // Показать блоки
          $('.la-block-content__htmlsaver', Article.Storage.Prehtml).show();

          // Видалити зайві атрибути
          $('.la-block-content__editable', Article.Storage.Prehtml).each(function () {
            $(this)
              .removeClass('mce-content-body')
              .removeAttr('id')
              .removeAttr('contenteditable')
              .removeAttr('spellcheck')
              .removeAttr('style');
          });

          // Закинути готовий контент статті у textarea для відправки на сервер
          Article.Storage.Textarea.val(Article.Storage.Prehtml.html());

          // Ініціювати відправку на сервер
          Article.Storage.Textarea.trigger('change');
        },

        // Додати нову секцію
        AddSection: function (Type, Section) {

          // Згенерувати ідентифікатор секції
          var id = Article.Action.GenerateID();

          // Додати секцію в поточний контейнер редактора
          if (Type === 'Append') {
            Article.Storage.Container.append(Article.Template.Section(id));
          } else if (Type === 'Before') {
            Section.parent().before(Article.Template.Section(id));
          } else if (Type === 'After') {
            Section.parent().after(Article.Template.Section(id));
          }

          // Ініціалізувати поточну секцію редактора
          Article.LinkyArticleSection($('.la-section--id' + id));
        },

        // Додати секції з обох боків
        AddBothSection: function (Section) {
          if (Section.hasClass('la-section--empty') === true) {
            Article.AddSection('Before', Section);
            Article.AddSection('After', Section);
          }
        },

        // Додати нову секцію у сітку
        AddSectionGrid: function (Type, Section) {

          // Згенерувати ідентифікатор блоку
          var id = Article.Action.GenerateID();

          // Додати блок в поточну секцію редактора
          if (Type === 'Append') {
            Article.Storage.Container.append(Article.Template.SectionGrid(id));
          } else if (Type === 'Before') {
            Section.parent().before(Article.Template.SectionGrid(id));
          } else if (Type === 'After') {
            Section.parent().after(Article.Template.SectionGrid(id));
          }

          // Ініціалізувати поточний блок
          Article.LinkyArticleBlock($('.la-block--id' + id));
        },

        // Додати секції з обох боків в боці сітки
        AddBothSectionGrid: function (Section) {
          if (Section.hasClass('la-block--empty') === true) {
            Article.AddSectionGrid('Before', Section);
            Article.AddSectionGrid('After', Section);
          }
        },

        // Додати нові блоки з боків в боці сітки
        AddBothBlockGrid: function (Type, Block) {
          if (Type === 'Before') {
            Article.AddSectionGrid('Before', Block);
          } else if (Type === 'After') {
            Article.AddSectionGrid('After', Block);
          }
        },

        // Створити новий блок статті заданого типу
        CreateBlock: function (Type, Block) {

          // HTML-код для вставки в блоки при створенні
          var html = '';
          switch (Type) {
          case 'Header':
            // html = '<h2>Заголовок</h2>';
            break;
          case 'Text':
            // html = '<p>Текст</p>';
            break;
          case 'List':
            // html = '<ul><li>Список</li></ul>';
            break;
          case 'Image':
            html = Article.Template.ImageBlock();
            break;
          case 'Media':
            // html = '<p>Видео</p>';
            break;
          case 'Table':
            // html = '<p>Таблица</p>';
            break;
          case 'Cite':
            // html = '<p>Цитата</p>';
            break;
          case 'Html':
            html = Article.Template.HtmlBlock();
            break;
          }

          var noImageClass = Type == 'Image' ? ' la-no-image' : '';

          // Власне вставка html-коду
          Block.find('.la-block-content').html('<div class="la-block-content__editable la-block-content__editable--' + Type.toLowerCase() + noImageClass +'" data-type="' + Type + '">' + html + '</div>').show();

          // Видалити мітку про те, що блок пустий
          Block.removeClass('la-block--empty');

          // Задіяти TinyMCE до відповідного блоку
          if (Type in Article.TinyMCE) {
            Article.TinyMCE.Init(Type);
          }

          // Додаткові дії для даного типу блоку
          if (Type in Article.BlockCustom) {
            Article.BlockCustom[Type](Block);
          }
        },

        // Ініціалізація секції статті
        LinkyArticleSection: function (Section) {
          // Завантажити додаткові компоненти секції при необхідності
          if (Section.find('.la-toolbar').length === 0) {
            Section.find('.la-grid').after(Article.Template.Toolbar());
          }
          
          if (Section.hasClass('la-section--hide')) {
              Section.find('.la-toolbar__button--hide i').toggleClass('ic_visibility ic_visibility_off');
          }

          // Активувати плагін вибору фонової картинки секції
          Section.find('.la-toolbar').find('.file-manager-button').fileManager('init');

          // Ініціалізувати блоки поточної секції
          Section.find('.la-block').each(function () {
            Article.LinkyArticleBlock($(this));
          });

          // Змінити колір фону секції
          var SectionBackgroundColor = 'ffffff';
          if (Section.attr('style')) {
            var SectionBackgroundColorArr = $.trim(Section.attr('style')).slice(22,-2).split(',');
            for (var i = 0; i < SectionBackgroundColorArr.length; i++) {
                SectionBackgroundColorArr[i] = $.trim(SectionBackgroundColorArr[i])
            }
            SectionBackgroundColor = {r:SectionBackgroundColorArr[0], g:SectionBackgroundColorArr[1], b:SectionBackgroundColorArr[2]}
          }
          Section.find('.la-toolbar__button--bgcolor').colpick({
            flat: false,
            submit: 0,
            color: SectionBackgroundColor,
            onChange: function (HSB, HEX, RGB) {
              Section.css('background-color', '#' + HEX);

              Section.find('.la-grid').removeAttr('style');

              // Article.SaveContent(Section); vsv
              $('.js-mobile-header-save-btn').fadeIn();
              $('.js-save-btn').fadeIn();
              $('.js-mobile-header-saved').hide();
              $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
            },
            onHide: function (HSB, HEX, RGB) {
              Section.css('background-color', '#' + HEX);

              Section.find('.la-grid').removeAttr('style');

              // Article.SaveContent(Section); vsv
              $('.js-mobile-header-save-btn').fadeIn();
              $('.js-save-btn').fadeIn();
              $('.js-mobile-header-saved').hide();
              $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
            }
          });

          // Встановити секцію у режим повного екрану
          Section.find('.la-toolbar__button--header').on('click', function () {

            if ($(this).closest('.la-section').hasClass('la-section--empty')) return;

            if ($(this).closest('.la-section').hasClass('la-section--fullWidth')) {
              $(this).removeClass('active').closest('.la-section').removeClass('la-section--fullWidth').attr({"data-vc-full-width":"", "data-vc-full-width-init":""});
              $(this).closest('.la-section').find('.vc_row-full-width').remove();
            } else {
              $(this).addClass('active').closest('.la-section').addClass('la-section--fullWidth').attr({"data-vc-full-width":"true", "data-vc-full-width-init":"true"});
              $(this).closest('.la-section').after('<div class="vc_row-full-width" />');
            }

            //console.log('l#818');
            // Article.SaveContent(Section); vsv
            $('.js-mobile-header-save-btn').fadeIn();
            $('.js-save-btn').fadeIn();
            $('.js-mobile-header-saved').hide();
            $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
          });

          // Показати тулбар секції
          Section.find('.la-toolbar').on('click', '.la-toolbar__button--toggle', function (event) {

            var $area = $(this).siblings('.la-toolbar__area--toggle');

            // Article.Storage.Container.find('.la-toolbar__area--toggle').hide().siblings('.la-toolbar__button--toggle').removeClass('btn-primary');

            if ($area.is(':visible')) {
              $area.hide().siblings('.la-toolbar__button--toggle').removeClass('btn-primary');
            } else {
              $area.show().siblings('.la-toolbar__button--toggle').addClass('btn-primary');
            }

            event.preventDefault();
          });

          // Виставити фонову картинку секції
          Section.find('.la-toolbar .file-manager-button').change( function (event) {            
            var $img = $(this).closest(".btn-group").find(".background-image li:last-child").find(".img-fluid");
            if ($img.length) {
              Section.attr('style', "background: url('" + ($img.attr('src-original') ? $img.attr('src-original') : $img.attr('src')) + "') no-repeat center / cover");
            }
          });

          // Поставити фонову картинку секції
          Section.find('.la-toolbar__button--bgimage').on('click', function () {
            Section.find('.la-toolbar .file-manager-control').trigger('click');
          });

          // Видалити секцію
          Section.find('.la-toolbar__button--remove').on('click', function (event) {
            event.preventDefault();

            var IsContent = false;
            Section.find('.la-block-content').each(function () {
              if ($(this).html()) {
                IsContent = true;
              }
            });

            if (IsContent) {
              if (!confirm('Секция не пустая, продолжить и удалить контент?')) return;
            }

            // Видалити верхню пусту секцію
            // Старий код
            // if (Section.parent().prev().find('.la-section').hasClass('la-section--empty')) {
            //   Section.parent().prev().remove();
            // }

            // Видалити нижню пусту секцію
            if (Section.parent().next().find('.la-section').hasClass('la-section--empty')) {
              Section.parent().next().remove();
            }

            // Видалити поточну секцію
            Section.parent().remove();

            // Очистити поточну секцію
            // Старий код
     //        if (!Section.hasClass('la-section--empty')) {

     //          Section.addClass('la-section--empty');

     //          Section.find('.la-block').each(function () {
     //            Section.find('.la-block-content').hide().empty();

     //            Section.find('.la-block-menu').hide();
     //            Section.find('.la-block-categories').hide();

     //            Section.find('.la-block-plus').show();

     //            $(this).removeAttr('style');
     //          });

     //          Section.find('.la-grid, .la-block').removeAttr('style');

     //          // Section.addClass('la-section--empty').find('.la-toolbar__button--changegrid .dropdown-menu a').first().trigger('click');

              // //console.log('l#907');
     //          Article.SaveContent(Section);
     //        }


            // Збереження нове
            // Article.SaveContent(); vsv
            $('.js-mobile-header-save-btn').fadeIn();
            $('.js-save-btn').fadeIn();
            $('.js-mobile-header-saved').hide();
            $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
          });

          // Очистити всі блоки секції
          Section.find('.la-toolbar__button--clear').on('click', function (event) {
            event.preventDefault();

            Section.find('.la-grid, .la-block').removeAttr('style');
            Section.removeAttr('style');

            //console.log('l#918');
            // Article.SaveContent(Section); vsv
            $('.js-mobile-header-save-btn').fadeIn();
            $('.js-save-btn').fadeIn();
            $('.js-mobile-header-saved').hide();
            $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
          });


          // Показати вікно вводу id
          Section.find('.la-toolbar__button--id-toggle').on('click', function() {
            $('#id-name').val($(this).closest('.la-section').attr('id'));
            $('#idModal').data('activeSection', $(this).closest('.la-section'));
            $('#idModal').data('createIdBtn', $(this));
            $('#idModal').data('Article', Article);
          });

          // Показати вікно вводу class
          Section.find('.la-toolbar__button--class-toggle').on('click', function() {
            $('#class-name').val($(this).closest('.la-section').attr('data-class'));
            $('#classModal').data('activeSection', $(this).closest('.la-section'));
            $('#classModal').data('createClassBtn', $(this));
            $('#classModal').data('Article', Article);
            $('#classModal .create-class-btn').removeClass('create-class-block-btn');
            $('#classModal .classes').html('');
          });
          
          // Сховати/Показати секцію
          Section.find('.la-toolbar__button--hide').on('click', function() {
                $(this).find('i').toggleClass('ic_visibility ic_visibility_off');
                Section.toggleClass('la-section--hide');
                
                $('.js-mobile-header-save-btn').fadeIn();
                $('.js-save-btn').fadeIn();
                $('.js-mobile-header-saved').hide();
                $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
          });

          
          // Записати поточний варіант сітки
          // var gridType = '';
          // Section.find('.grid-block').each(function (index) {
          //   $(this).removeClass('grid-block');
          //   if (index === 0) {
          //     gridType += $.trim($(this).attr('class')).slice(10);
          //   } else {
          //     gridType += '-' + $.trim($(this).attr('class')).slice(10);
          //   }
          //   $(this).addClass('grid-block');
          // });
          // Section.find('.another-grid').val(gridType);


          // Відкрити вікно зміни сітки
          Section.find('.la-toolbar__button--changegrid').on('click', function (event) {
            event.preventDefault();
            $('#gridModal').data('activeSection', $(this).closest('.la-section'));
            $('#gridModal').data('createGrid', false);
            $('#gridModal').data('Article', Article);
            $('#gridModal').find('.grid-item').removeClass('active');
            $('#gridModal .create-grid-btn').addClass('change-grid-btn');
            $('#gridModal').find('.grid-menu a').each(function(index, el) {
                if ($(this).attr('data-grid') == $('#gridModal').data('activeSection').attr('data-active-grid')) {
                    $(this).parent().addClass('active');
                }
                $(this).on('click', function(event) {
                    event.preventDefault();

                    $(this).parent().siblings('.active').removeClass('active');
                    $(this).parent().addClass('active');
                });
            });
          });

          // Копіювання контенту секції
          Section.find('.la-toolbar__button--copy').on('click', function() {
            if ($(this).closest('.la-section').attr('data-class')) {
              $(this).closest('.la-section').find('.la-grid').attr('data-section-class', $(this).closest('.la-section').attr('data-class'));
            }
            if ($(this).closest('.la-section').attr('id')) {
              $(this).closest('.la-section').find('.la-grid').attr('data-section-id', $(this).closest('.la-section').attr('id'));
            }
            if ($(this).closest('.la-section').attr('style')) {
              $(this).closest('.la-section').find('.la-grid').attr('data-section-style', $(this).closest('.la-section').attr('style'));
            }
            var activeSection = $(this).closest('.la-section'),
                SectionContent = $(this).closest('.la-section').html();

            $(this).closest('.la-section').find('.la-grid').removeAttr('data-section-class').removeAttr('data-section-id');
            $.ajax({
              url: '/admin/ajax/buffer.htm',
              data: {
                key: 'redactorSection', // обязательный параметр, ключ который определяет что сохраняется, только английские символы например: 'redactorBlock', 'redactorSection', 'redactorContent' etc
                data: SectionContent, // далее сколько угодно данных
                data2: 'dgsdgsh',
                somedata: 21423532,
                abc: '3teterg'
              },
              dataType: 'jsonp',
              method: 'POST', // POST чтобы сохранить в буфер
              success: function (data) {
                console.log(data); // должен вернуть объект data который был передан выше
                //data.error - сообщение об ошибке, если оно есть значит буфер не сохранен
                
                $('body').removeClass('no-copy-section');

                // Добавити проміжні пусті секції
                if (!activeSection.parent().prev().find('.la-section--empty').length) {
                  Article.AddSection('Before', activeSection);
                } 
                if (!activeSection.parent().next().find('.la-section--empty').length) {
                  Article.AddSection('After', activeSection);
                }
              }
            });
          });

          // Вставка контенту секції
          Section.find('.la-toolbar__button--insert').on('click', function() {
            var activeSection = $(this).closest('.la-section');
            $.ajax({
              url: '/admin/ajax/buffer.htm',
              data: {
                key: 'redactorSection', // обязательный параметр, ключ который определяет что нужно получить, только английские символы например: 'redactorBlock', 'redactorSection', 'redactorContent' etc
              },
              dataType: 'jsonp',
              method: 'GET', // GET чтобы получить данные из буфера
              success: function (data) {
                activeSection.html(data.data);

                activeSection.find('.la-toolbar').remove();
                activeSection.find('.la-control').remove();
                activeSection.find('.la-block-categories').remove();
                activeSection.find('.la-block-plus').remove();
                activeSection.find('.la-block-menu').remove();

                // Добавити проміжні пусті секції
                if (!activeSection.parent().prev('.lb-row').find('.la-section--empty').length) {
                  Article.AddSection('Before', activeSection);
                } 
                if (!activeSection.parent().next('.lb-row').find('.la-section--empty').length) {
                  Article.AddSection('After', activeSection);
                }

                activeSection.removeClass('la-section--empty');

                if (activeSection.find('.la-grid').attr('data-section-class')) {
                  var activeSectionClass = activeSection.find('.la-grid').attr('data-section-class');
                  activeSection.addClass(activeSectionClass).attr('data-class', activeSectionClass);
                  activeSection.find('.la-grid').removeAttr('data-section-class');
                }
                if (activeSection.find('.la-grid').attr('data-section-id')) {
                  var activeSectionId = activeSection.find('.la-grid').attr('data-section-id');
                  activeSection.attr('id', activeSectionId);
                  activeSection.find('.la-grid').removeAttr('data-section-id');
                }
                if (activeSection.find('.la-grid').attr('data-section-style')) {
                  var activeSectionStyle = activeSection.find('.la-grid').attr('data-section-style');
                  activeSection.attr('style', activeSectionStyle);
                  activeSection.find('.la-grid').removeAttr('data-section-style');
                }

                Article.LinkyArticleSection(activeSection);

                $('.js-mobile-header-save-btn').fadeIn();
                $('.js-save-btn').fadeIn();
                $('.js-mobile-header-saved').hide();
                $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
              }
            });
          });
        },

        // Ініціалізація блоку статті
        LinkyArticleBlock: function (Block) {

          // Завантажити додаткові компоненти блоку при необхідності
          if (Block.find('.la-block-plus').length === 0) {
            Block.append(Article.Template.Categories() + Article.Template.PlusBlock() + Article.Template.Menu());
            
            if (Block.hasClass('la-block--hide')) {
                Block.find('.la-block-menu__button--hide i').toggleClass('ic_visibility ic_visibility_off');
            }

            // Якщо блок HTML
            if (Block.find('.la-block-content__editable').data('type') === 'Html') {

              Block.find('.la-block-content__editable').append(Article.Template.HtmlBlock(true));
              Block.find('.la-block-content__htmlarea').val(Block.find('.la-block-content__htmlsaver').html());

              Article.BlockCustom.Html(Block, true);

              // Якщо блок Зображення
            } else if (Block.find('.la-block-content__editable').data('type') === 'Image') {

              Block.find('.la-block-content__editable').prepend(Article.Template.ImageBlock(true));

              var ids = '';
              // var url = '';
              Block.find('.la-block-content__editable .img-list img').each(function () {

                if (ids) {
                  ids += ',';
                }

                // <input id="test" type="hidden" name="article[photo_id]" value="<{$article.photo_id|escape}>" data-toggle="fileManager" data-url="<{$article.file_manager_url|escape}>" data-control=".js-blog-cover" />
                ids += $(this).attr('fileid');
                console.log(ids);
                fileId = randomString(8);
                // fileId = $(this).closest('ul')['0'].className.split(" ")['2']
                url = document.getElementById('data-url').innerHTML;
                $(this).closest('.la-block-content__editable--image').find(".file-manager-button").attr("value", fileId);
                $(this).closest('li').find('.edit-photo-btn').length ? false : $(this).closest('li').append('<a class="la-block-image-text-button edit-photo-btn" title="Редактировать изображение"><span class="material-icons ic_mode_edit"></span></a>');
                $(this).closest('li').find('.la-image-containe').length ? false : $(this).closest('li').wrapInner('<div class="la-image-container js-file-manager-control-file file-manager-control-file">');
                $(this).closest('li').find('.la-image-containe').length ? false : $(this).closest('li').append($(this).closest('li').find('.img-description'));
                
                $('.file-manager-button').each(function() {
                  console.log($(this));
                  $(this).fileManager('init');
                });
                $('.edit-photo-btn').on("click", function() {                  
                  $(this).closest('.img-list-wrapper').find('.file-manager-control').trigger('click')
                })
              });

              Article.BlockCustom.Image(Block, ids);
            } else if (Block.find('.tag-block').length) {
              if (Block.find('.tag-block').hasClass('tag-goods-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-goods__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Товары</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-goods__button--setting').on('click', function () {
                  $('.tag-goods').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-brands-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-brands__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Бренды</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-brands__button--setting').on('click', function () {
                  $('.tag-brands').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-albums-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-albums__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Фотоальбомы</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-albums__button--setting').on('click', function () {
                  $('.tag-albums').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-photo-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-photo__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Фотогалерея</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-photo__button--setting').on('click', function () {
                  $('.tag-photo').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-last_news-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-last_news__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Статьи</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-last_news__button--setting').on('click', function () {
                  $('.tag-last_news').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-reviews-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-reviews__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Отзывы</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-reviews__button--setting').on('click', function () {
                  $('.tag-reviews').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-events-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-events__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">События</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-events__button--setting').on('click', function () {
                  $('.tag-events').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-employees-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-employees__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Сотрудники</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-employees__button--setting').on('click', function () {
                  $('.tag-employees').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-forms-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-forms__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">'+Block.find('.tag-block').attr('data-name')+'</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-forms__button--setting').on('click', function () {
                  $('.tag-forms').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-catalog-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-title">Каталог</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
              } else if (Block.find('.tag-block').hasClass('tag-youtube-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-youtube__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Youtube видео</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-youtube__button--setting').on('click', function () {
                  $('.tag-youtube').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-instagram-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-instagram__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Instagram фото</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-instagram__button--setting').on('click', function () {
                  $('.tag-instagram').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-vk_photo-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-vk_photo__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Vk фото</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-vk_photo__button--setting').on('click', function () {
                  $('.tag-vk_photo').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-vk_post-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-vk_post__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Vk пост/опрос</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-vk_post__button--setting').on('click', function () {
                  $('.tag-vk_post').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-js-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-js__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">javaScript</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-js__button--setting').on('click', function () {
                  $('.tag-js').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-voting-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-voting__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Голосование</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-voting__button--setting').on('click', function () {
                  $('.tag-voting').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              } else if (Block.find('.tag-block').hasClass('tag-instagram2-block')) {
                Block.find('.tag-block').prepend(
                  '<div class="tag-control">'+
                    '<button type="button" class="btn btn-default btn-sm tag-instagram2__button--setting"><i class="material-icons ic_settings"></i></button>'+
                  '</div>'+
                  '<div class="tag-title">Instagram профиль</div>'+
                  '<div class="tag-image">'+
                    '<img src="">'+
                  '</div>'
                );
                Block.find('.tag-instagram2__button--setting').on('click', function () {
                  $('.tag-instagram2').data('activeBlock', $(this).closest('.la-block')).data('Article', Article).addClass('edit-tag').trigger('click');
                });
              }
            }

            // Якщо блок не пустий - сховати кнопку "+"
            if (!Block.hasClass('la-block--empty')) {
              Block.find('.la-block-plus').hide();
            }
          }


          // Кнопка "Добавить секцию с контентом"
          Block.find('.la-block-plus__button').on('click', function (event) {
            event.preventDefault();
            $('#gridModal').data('activeSection', $(this).closest('.la-section'));
            $('#gridModal').data('Article', Article);
            $('#gridModal').data('createGrid', true);
            $('#gridModal').find('.grid-item').removeClass('active');
            $('#gridModal').find('.grid-menu a').each(function(index, el) {
                if ($(this).attr('data-grid') == $('#gridModal').data('activeSection').attr('data-active-grid')) {
                    $(this).parent().addClass('active');
                }
                $(this).on('click', function(event) {
                    event.preventDefault();

                    $(this).parent().siblings('.active').removeClass('active');
                    $(this).parent().addClass('active');
                });
            });
          });

          // Кнопка "+"
          Block.find('.la-block-plus__btn').on('click', function (event) {
            event.preventDefault();
            Article.AddBothSectionGrid(Block);
            $(this).parent().hide();
            Block.find('.la-block-categories').show();
            Block.removeClass('la-block--noactive');
            Block.find('.la-block-categories-btns-toggle').trigger('click');
          });

          // Block.find('.la-block-plus-block').on('click', function (event) {
          //   $(this).find('.la-block-plus__btn').trigger('click');
          // });



          // Кнопки створення нового блоку статті відповідного типу
          Block.find('.la-block-categories__button').on('click', function (event) {
            event.preventDefault();

            Block.find('.la-block-categories').hide();

            Article.CreateBlock($(this).data('category'), Block);
            $('.file-manager-button').each(function() {
              $(this).fileManager('init');
            });
          });

          // Показати/Приховати меню блоку
          Block.on('mouseenter', function () {
            if ($('.la-block-content', this).css('display') === 'block' && !Block.hasClass('la-block--empty')) {
              Block.find('.la-block-menu__confirm').hide();
              Block.find('.la-block-menu__operations').show();
              Block.find('.la-block-menu').stop().show();
            }
          }).on('mouseleave', function () {
            if (!Block.hasClass('la-block--empty')) {
              Block.find('.la-block-menu').stop().hide();
            }
          });

          // Скасувати виконання призначеної операції
          Block.find('.la-block-menu__button--cancel').on('click', function (event) {
            event.preventDefault();
            Block.find('.la-block-menu__confirm').hide();
            Block.find('.la-block-menu__operations').show();
          });

          // Змінити тип блоку
          Block.find('.la-block-menu__button--changetype').on('click', function () {
            Article.ConfirmOperation('ChangeType', Block);
          });

          // Показати меню налаштувань блоку
          Block.find('.la-block-settings__button').on('click', function () {
            $(this).closest('.la-block-categories').hide();
            $(this).closest('.la-block').find('.la-block-menu').show();
          });

          // Показати меню вибору типу блоку
          Block.find('.la-block-menu__button--setting').on('click', function () {
            $(this).closest('.la-block-menu').hide();
            $(this).closest('.la-block').find('.la-block-categories').show();
          });

          // Видалити блок
          Block.find('.la-block-menu__button--remove').on('click', function () {
            event.preventDefault();
            Block.find('.la-block-content').hide().empty();
            Block.css('background-color', 'transparent');
            Block.find('.la-block-menu').hide();
            Block.find('.la-block-menu__confirm').hide();
            Block.find('.la-block-plus').show();
            Block.addClass('la-block--empty la-block--noactive').removeData('type');
            if ($(this).closest('.grid-block')) {
            $(this).closest('.lb-row').prev().remove();
            $(this).closest('.lb-row').next().remove();
            }
            // Article.SaveContent($(this).closest('.la-section')); vsv
            $('.js-mobile-header-save-btn').fadeIn();
            $('.js-save-btn').fadeIn();
            $('.js-mobile-header-saved').hide();
            $('.js-mobile-header-unsaved').addClass('showed').fadeIn();

            // Article.ConfirmOperation('RemoveBlock', Block);
            // Article.SaveContent($(this).closest('.la-section'));
          });

          // Змінити колір блоку
          var BlockBackgroundColor = 'ffffff';
          if (Block.attr('style')) {
            var BlockBackgroundColorArr = $.trim(Block.attr('style')).slice(22,-2).split(',');
            for (var i = 0; i < BlockBackgroundColorArr.length; i++) {
                BlockBackgroundColorArr[i] = $.trim(BlockBackgroundColorArr[i])
            }
            BlockBackgroundColor = {r:BlockBackgroundColorArr[0], g:BlockBackgroundColorArr[1], b:BlockBackgroundColorArr[2]}
          }
          Block.find('.la-block-menu__button--bgcolor').colpick({
            flat: false,
            submit: 0,
            color: BlockBackgroundColor,
            onChange: function (HSB, HEX, RGB) {
              Block.css('background-color', '#' + HEX);
              // Article.SaveContent($(this).closest('.la-section')); vsv
              $('.js-mobile-header-save-btn').fadeIn();
              $('.js-save-btn').fadeIn();
              $('.js-mobile-header-saved').hide();
              $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
            },
            onHide: function (HSB, HEX, RGB) {
              Block.css('background-color', '#' + HEX);
              // Article.SaveContent($(this).closest('.la-section')); vsv
              $('.js-mobile-header-save-btn').fadeIn();
              $('.js-save-btn').fadeIn();
              $('.js-mobile-header-saved').hide();
              $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
            }
          });

          if (Block.attr('img-id')) {
            Block.find('.file-manager-button').val(Block.attr('img-id'));
          }

          // Активувати плагін завантаження зображень для фону
          Block.find('.la-block-menu .file-manager-button').fileManager('init');

          // Виставити фонову картинку блоку
          Block.find('.la-block-menu__operations-btns .file-manager-button').on("change", function (event) {            
            var id = $(this).val();
            var $img = $(this).closest(".la-block-menu__operations-btns").find(".background-image li:last-child").find(".img-fluid");
            if ($img.length) {
              Block.attr('style', "background: url('" + ($img.attr('src-original') ? $img.attr('src-original') : $img.attr('src'))  + "')" + " no-repeat center / cover");
              Block.attr('img-id', id);
            }
          });

          // Активувати кнопку вибору зображень для фону
          Block.find('.la-block-menu__button--bgimg').on('click', function () {
              Block.find('.la-block-menu .file-manager-control').trigger('click');
          });
          
          // Скрити/показати блок
          Block.find('.la-block-menu__button--hide').on('click', function () {
                $(this).find('i').toggleClass('ic_visibility ic_visibility_off');
                Block.toggleClass('la-block--hide');
                
                $('.js-mobile-header-save-btn').fadeIn();
                $('.js-save-btn').fadeIn();
                $('.js-mobile-header-saved').hide();
                $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
          });

          // Показати вікно вводу class
          Block.find('.la-block-menu__button--class-toggle').on('click', function() {
            $('#class-name').val($(this).closest('.la-block').attr('data-class'));
            $('#classModal').data('activeBlock', $(this).closest('.la-block'));
            $('#classModal').data('createClassBtn', $(this));
            $('#classModal').data('Article', Article);
            $('#classModal .create-class-btn').addClass('create-class-block-btn');
            if ($(this).closest('.la-block').find('.la-block-content__editable--header').length) {
              if ("header" in classesObject) {
                var classesType = classesObject['header'],
                    html = '';
                for (group in classesType) {
                  html += '<div class="row">';
                  html += '<div class="col-sm-12">';
                  html += '<h2 class="title-text">';
                  html += classesType[group].name;
                  html += '</h2>';
                  html += '</div>';
                  for (classInfo in classesType[group].classes) {
                    html += '<div class="col-sm-3 nclass-wrp">';
                    html += '<div class="nclass" data-nclass-val="'+classesType[group].classes[classInfo].class+'" title="'+classesType[group].classes[classInfo].description+'">';
                    html += '<div class="nclass-name">';
                    html += classesType[group].classes[classInfo].name;
                    html += '</div>';
                    html += '<div class="nclass-photo">';
                    html += '<img src="'+classesType[group].classes[classInfo].photo+'"/>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                  }
                  html += '</div>';
                }
                $('#classModal .classes').html(html);
                if ($(this).closest('.la-block').attr('data-nclass')) {
                  var dataNclass = $(this).closest('.la-block').attr('data-nclass').split(' ');
                  for (var i = 0; i < dataNclass.length; i++) {
                    $('#classModal .classes .nclass').each(function() {
                      if ($(this).attr('data-nclass-val') == dataNclass[i]) {
                        $(this).parent().addClass('active');
                      }
                    });
                  }
                  
                }
                $('#classModal .classes .nclass-wrp').each(function() {
                  $(this).on('click', function () {
                    if ($(this).hasClass('active')) {
                      $(this).removeClass('active');
                      return
                    }
                    $(this).siblings('.active').removeClass('active');
                    $(this).addClass('active');
                  });
                });
              }
            } else if ($(this).closest('.la-block').find('.la-block-content__editable--text').length) {
              if ("text" in classesObject) {
                var classesType = classesObject['text'],
                    html = '';
                for (group in classesType) {
                  html += '<div class="row">';
                  html += '<div class="col-sm-12">';
                  html += '<h2 class="title-text">';
                  html += classesType[group].name;
                  html += '</h2>';
                  html += '</div>';
                  for (classInfo in classesType[group].classes) {
                    html += '<div class="col-sm-3 nclass-wrp">';
                    html += '<div class="nclass" data-nclass-val="'+classesType[group].classes[classInfo].class+'" title="'+classesType[group].classes[classInfo].description+'">';
                    html += '<div class="nclass-name">';
                    html += classesType[group].classes[classInfo].name;
                    html += '</div>';
                    html += '<div class="nclass-photo">';
                    html += '<img src="'+classesType[group].classes[classInfo].photo+'"/>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                  }
                  html += '</div>';
                }
                $('#classModal .classes').html(html);
                if ($(this).closest('.la-block').attr('data-nclass')) {
                  var dataNclass = $(this).closest('.la-block').attr('data-nclass').split(' ');
                  for (var i = 0; i < dataNclass.length; i++) {
                    $('#classModal .classes .nclass').each(function() {
                      if ($(this).attr('data-nclass-val') == dataNclass[i]) {
                        $(this).parent().addClass('active');
                      }
                    });
                  }
                  
                }
                $('#classModal .classes .nclass-wrp').each(function() {
                  $(this).on('click', function () {
                    if ($(this).hasClass('active')) {
                      $(this).removeClass('active');
                      return
                    }
                    $(this).siblings('.active').removeClass('active');
                    $(this).addClass('active');
                  });
                });
              }
            } else if ($(this).closest('.la-block').find('.la-block-content__editable--list').length) {
              if ("list" in classesObject) {
                var classesType = classesObject['list'],
                    html = '';
                for (group in classesType) {
                  html += '<div class="row">';
                  html += '<div class="col-sm-12">';
                  html += '<h2 class="title-text">';
                  html += classesType[group].name;
                  html += '</h2>';
                  html += '</div>';
                  for (classInfo in classesType[group].classes) {
                    html += '<div class="col-sm-3 nclass-wrp">';
                    html += '<div class="nclass" data-nclass-val="'+classesType[group].classes[classInfo].class+'" title="'+classesType[group].classes[classInfo].description+'">';
                    html += '<div class="nclass-name">';
                    html += classesType[group].classes[classInfo].name;
                    html += '</div>';
                    html += '<div class="nclass-photo">';
                    html += '<img src="'+classesType[group].classes[classInfo].photo+'"/>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                  }
                  html += '</div>';
                }
                $('#classModal .classes').html(html);
                if ($(this).closest('.la-block').attr('data-nclass')) {
                  var dataNclass = $(this).closest('.la-block').attr('data-nclass').split(' ');
                  for (var i = 0; i < dataNclass.length; i++) {
                    $('#classModal .classes .nclass').each(function() {
                      if ($(this).attr('data-nclass-val') == dataNclass[i]) {
                        $(this).parent().addClass('active');
                      }
                    });
                  }
                  
                }
                $('#classModal .classes .nclass-wrp').each(function() {
                  $(this).on('click', function () {
                    if ($(this).hasClass('active')) {
                      $(this).removeClass('active');
                      return
                    }
                    $(this).siblings('.active').removeClass('active');
                    $(this).addClass('active');
                  });
                });
              }
            } else if ($(this).closest('.la-block').find('.img-preview').length) {
              if ("photo_preview" in classesObject) {
                var classesType = classesObject['photo_preview'],
                    html = '';
                for (group in classesType) {
                  html += '<div class="row">';
                  html += '<div class="col-sm-12">';
                  html += '<h2 class="title-text">';
                  html += classesType[group].name;
                  html += '</h2>';
                  html += '</div>';
                  for (classInfo in classesType[group].classes) {
                    html += '<div class="col-sm-3 nclass-wrp">';
                    html += '<div class="nclass" data-nclass-val="'+classesType[group].classes[classInfo].class+'" title="'+classesType[group].classes[classInfo].description+'">';
                    html += '<div class="nclass-name">';
                    html += classesType[group].classes[classInfo].name;
                    html += '</div>';
                    html += '<div class="nclass-photo">';
                    html += '<img src="'+classesType[group].classes[classInfo].photo+'"/>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                  }
                  html += '</div>';
                }
                $('#classModal .classes').html(html);
                if ($(this).closest('.la-block').attr('data-nclass')) {
                  var dataNclass = $(this).closest('.la-block').attr('data-nclass').split(' ');
                  for (var i = 0; i < dataNclass.length; i++) {
                    $('#classModal .classes .nclass').each(function() {
                      if ($(this).attr('data-nclass-val') == dataNclass[i]) {
                        $(this).parent().addClass('active');
                      }
                    });
                  }
                  
                }
                $('#classModal .classes .nclass-wrp').each(function() {
                  $(this).on('click', function () {
                    if ($(this).hasClass('active')) {
                      $(this).removeClass('active');
                      return
                    }
                    $(this).siblings('.active').removeClass('active');
                    $(this).addClass('active');
                  });
                });
              }
            } else if ($(this).closest('.la-block').find('.img-gallery').length) {
              if ("photo_gallery" in classesObject) {
                var classesType = classesObject['photo_gallery'],
                    html = '';
                for (group in classesType) {
                  html += '<div class="row">';
                  html += '<div class="col-sm-12">';
                  html += '<h2 class="title-text">';
                  html += classesType[group].name;
                  html += '</h2>';
                  html += '</div>';
                  for (classInfo in classesType[group].classes) {
                    html += '<div class="col-sm-3 nclass-wrp">';
                    html += '<div class="nclass" data-nclass-val="'+classesType[group].classes[classInfo].class+'" title="'+classesType[group].classes[classInfo].description+'">';
                    html += '<div class="nclass-name">';
                    html += classesType[group].classes[classInfo].name;
                    html += '</div>';
                    html += '<div class="nclass-photo">';
                    html += '<img src="'+classesType[group].classes[classInfo].photo+'"/>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                  }
                  html += '</div>';
                }
                $('#classModal .classes').html(html);
                if ($(this).closest('.la-block').attr('data-nclass')) {
                  var dataNclass = $(this).closest('.la-block').attr('data-nclass').split(' ');
                  for (var i = 0; i < dataNclass.length; i++) {
                    $('#classModal .classes .nclass').each(function() {
                      if ($(this).attr('data-nclass-val') == dataNclass[i]) {
                        $(this).parent().addClass('active');
                      }
                    });
                  }
                  
                }
                $('#classModal .classes .nclass-wrp').each(function() {
                  $(this).on('click', function () {
                    if ($(this).hasClass('active')) {
                      $(this).removeClass('active');
                      return
                    }
                    $(this).siblings('.active').removeClass('active');
                    $(this).addClass('active');
                  });
                });
              }
            } else if ($(this).closest('.la-block').find('.img-slider').length) {
              if ("photo_slider" in classesObject) {
                var classesType = classesObject['photo_slider'],
                    html = '';
                for (group in classesType) {
                  html += '<div class="row">';
                  html += '<div class="col-sm-12">';
                  html += '<h2 class="title-text">';
                  html += classesType[group].name;
                  html += '</h2>';
                  html += '</div>';
                  for (classInfo in classesType[group].classes) {
                    html += '<div class="col-sm-3 nclass-wrp">';
                    html += '<div class="nclass" data-nclass-val="'+classesType[group].classes[classInfo].class+'" title="'+classesType[group].classes[classInfo].description+'">';
                    html += '<div class="nclass-name">';
                    html += classesType[group].classes[classInfo].name;
                    html += '</div>';
                    html += '<div class="nclass-photo">';
                    html += '<img src="'+classesType[group].classes[classInfo].photo+'"/>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                  }
                  html += '</div>';
                }
                $('#classModal .classes').html(html);
                if ($(this).closest('.la-block').attr('data-nclass')) {
                  var dataNclass = $(this).closest('.la-block').attr('data-nclass').split(' ');
                  for (var i = 0; i < dataNclass.length; i++) {
                    $('#classModal .classes .nclass').each(function() {
                      if ($(this).attr('data-nclass-val') == dataNclass[i]) {
                        $(this).parent().addClass('active');
                      }
                    });
                  }
                  
                }
                $('#classModal .classes .nclass-wrp').each(function() {
                  $(this).on('click', function () {
                    if ($(this).hasClass('active')) {
                      $(this).removeClass('active');
                      return
                    }
                    $(this).siblings('.active').removeClass('active');
                    $(this).addClass('active');
                  });
                });
              }
            } else if ($(this).closest('.la-block').find('.la-block-content__editable--table').length) {
              if ("table" in classesObject) {
                var classesType = classesObject['table'],
                    html = '';
                for (group in classesType) {
                  html += '<div class="row">';
                  html += '<div class="col-sm-12">';
                  html += '<h2 class="title-text">';
                  html += classesType[group].name;
                  html += '</h2>';
                  html += '</div>';
                  for (classInfo in classesType[group].classes) {
                    html += '<div class="col-sm-3 nclass-wrp">';
                    html += '<div class="nclass" data-nclass-val="'+classesType[group].classes[classInfo].class+'" title="'+classesType[group].classes[classInfo].description+'">';
                    html += '<div class="nclass-name">';
                    html += classesType[group].classes[classInfo].name;
                    html += '</div>';
                    html += '<div class="nclass-photo">';
                    html += '<img src="'+classesType[group].classes[classInfo].photo+'"/>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                  }
                  html += '</div>';
                }
                $('#classModal .classes').html(html);
                if ($(this).closest('.la-block').attr('data-nclass')) {
                  var dataNclass = $(this).closest('.la-block').attr('data-nclass').split(' ');
                  for (var i = 0; i < dataNclass.length; i++) {
                    $('#classModal .classes .nclass').each(function() {
                      if ($(this).attr('data-nclass-val') == dataNclass[i]) {
                        $(this).parent().addClass('active');
                      }
                    });
                  }
                  
                }
                $('#classModal .classes .nclass-wrp').each(function() {
                  $(this).on('click', function () {
                    if ($(this).hasClass('active')) {
                      $(this).removeClass('active');
                      return
                    }
                    $(this).siblings('.active').removeClass('active');
                    $(this).addClass('active');
                  });
                });
              }
            } else if ($(this).closest('.la-block').find('.la-block-content__editable--cite').length) {
              if ("quote" in classesObject) {
                var classesType = classesObject['quote'],
                    html = '';
                for (group in classesType) {
                  html += '<div class="row">';
                  html += '<div class="col-sm-12">';
                  html += '<h2 class="title-text">';
                  html += classesType[group].name;
                  html += '</h2>';
                  html += '</div>';
                  for (classInfo in classesType[group].classes) {
                    html += '<div class="col-sm-3 nclass-wrp">';
                    html += '<div class="nclass" data-nclass-val="'+classesType[group].classes[classInfo].class+'" title="'+classesType[group].classes[classInfo].description+'">';
                    html += '<div class="nclass-name">';
                    html += classesType[group].classes[classInfo].name;
                    html += '</div>';
                    html += '<div class="nclass-photo">';
                    html += '<img src="'+classesType[group].classes[classInfo].photo+'"/>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                  }
                  html += '</div>';
                }
                $('#classModal .classes').html(html);
                if ($(this).closest('.la-block').attr('data-nclass')) {
                  var dataNclass = $(this).closest('.la-block').attr('data-nclass').split(' ');
                  for (var i = 0; i < dataNclass.length; i++) {
                    $('#classModal .classes .nclass').each(function() {
                      if ($(this).attr('data-nclass-val') == dataNclass[i]) {
                        $(this).parent().addClass('active');
                      }
                    });
                  }
                  
                }
                $('#classModal .classes .nclass-wrp').each(function() {
                  $(this).on('click', function () {
                    if ($(this).hasClass('active')) {
                      $(this).removeClass('active');
                      return
                    }
                    $(this).siblings('.active').removeClass('active');
                    $(this).addClass('active');
                  });
                });
              }
            }
          });

          // Копіювання контенту блоку
          Block.find('.la-block-menu__button--copy').on('click', function() {
            if ($(this).closest('.la-block').attr('data-nclass')) {
              $(this).closest('.la-block').find('.la-block-content').attr('data-block-nclass', $(this).closest('.la-block').attr('data-nclass'));
            }
            if ($(this).closest('.la-block').attr('data-class')) {
              $(this).closest('.la-block').find('.la-block-content').attr('data-block-class', $(this).closest('.la-block').attr('data-class'));
            }
            if ($(this).closest('.la-block').attr('style')) {
              $(this).closest('.la-block').find('.la-block-content').attr('data-block-style', $(this).closest('.la-block').attr('style'));
            }
            var BlockContent = $(this).closest('.la-block').html();
            $(this).closest('.la-block').find('.la-block-content').removeAttr('data-block-nclass');
            $(this).closest('.la-block').find('.la-block-content').removeAttr('data-block-class');
            $.ajax({
              url: $(".js-redactor").attr("data-url") + '&action=buffer',
              //url: '/admin/ajax/buffer.htm',
              data: {
                key: 'redactorBlock',
                data: BlockContent,
                data2: 'dgsdgsh',
                somedata: 21423532,
                abc: '3teterg'
              },
              dataType: 'jsonp',
              method: 'POST',
              success: function (data) {
                console.log(data);
                $('body').removeClass('no-copy-block');
              },
              error: function (err) {
                console.log(err);
              }
            });
          });

          // Вставка контенту блоку
          Block.find('.la-block-menu__button--insert, .la-block-insert__button').on('click', function() {
            var activeBlock = $(this).closest('.la-block');
            $.ajax({
              url: $(".js-redactor").attr("data-url") + '&action=buffer',
              data: {
                key: 'redactorBlock',
              },
              dataType: 'jsonp',
              method: 'GET',
              success: function (data) {
                activeBlock.html(data.data);

                activeBlock.find('.la-control').remove();
                activeBlock.find('.la-block-categories').remove();
                activeBlock.find('.la-block-plus').remove();
                activeBlock.find('.la-block-menu').remove();

                activeBlock.removeClass('la-block--empty');

                if (activeBlock.find('.la-block-content').attr('data-block-nclass')) {
                  var activeBlockNClass = activeBlock.find('.la-block-content').attr('data-block-nclass');
                  activeBlock.addClass(activeBlockNClass).attr('data-nclass', activeBlockNClass);
                  activeBlock.find('.la-block-content').removeAttr('data-block-nclass');
                }
                if (activeBlock.find('.la-block-content').attr('data-block-class')) {
                  var activeBlockClass = activeBlock.find('.la-block-content').attr('data-block-class');
                  activeBlock.addClass(activeBlockClass).attr('data-class', activeBlockClass);
                  activeBlock.find('.la-block-content').removeAttr('data-block-class');
                }
                if (activeBlock.find('.la-block-content').attr('data-block-style')) {
                  var activeBlockStyle = activeBlock.find('.la-block-content').attr('data-block-style');
                  activeBlock.attr('style', activeBlockStyle);
                  activeBlock.find('.la-block-content').removeAttr('data-block-style');
                }

                Article.LinkyArticleBlock(activeBlock);

                $('.js-mobile-header-save-btn').fadeIn();
                $('.js-save-btn').fadeIn();
                $('.js-mobile-header-saved').hide();
                $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
              }
            });
          });

          // Відкриття вікна вибору тега (передача даних)
          Block.find('.la-block-tag__button').on('click', function () {
            $('#tagsModal').data('activeBlock', $(this).closest('.la-block'));
            $('#tagsModal').data('Article', Article);
          });

          // Показати меню редагування блока
          Block.find('.la-block-menu__button--toggle-menu').on('click', function() {
            $(this).siblings('.la-block-menu__operations-btns').toggleClass('active');
          });
          

          // Показати меню вибору типу блока
          Block.find('.la-block-categories-btns-toggle').on('click', function() {
            $(this).siblings('.la-block-categories-btns').css('display', 'inline-block');
            $(this).hide();
          });

          // Вибрати фото
          Block.on('click', '.btn-add-image', function (event) {
            event.preventDefault();
            $(this).closest('.la-block-content__editable').find('.file-manager-control').trigger('click');
          });

          // Опис фото
          var updatePhotoXhr = false;
          Block.on('click', '.la-block-image-text-button', function (event) {
            event.preventDefault();
            $(this).closest('.img-list-wrapper').find('.file-manager-control').trigger('click')

            if (updatePhotoXhr) {
              updatePhotoXhr.abort();
            }

            var activeModal = $(this).closest('.la-block').find('.la-control .attachment-ajax').data('$button').data('$popup'),
                attachmentAjax = $(this).closest('.la-block').find('.la-control .attachment-ajax');

            updatePhotoXhr = $.ajax({
              url: activeModal.attr('url'),
              data: {
                act: 'updatePhoto',
                url: activeModal.attr('url'),
                attachmentFileId: $(this).attr('la-image-file-id')
              },
              context: activeModal,
              dataType: 'jsonp',
              success: function (data) {
                var $popup = activeModal;
                $popup.modal('hide');
                var $modal = $(data.modal).appendTo(document.body);
                $modal.data('$popup', $popup);

                $modal.modal({show: true}).on('hidden.bs.modal', function (e) {
                    $(this).remove();
                    attachmentAjax.trigger('change');
                });
                
                var clipboard = new Clipboard('.photo-date-insert-link');

                clipboard.on('success', function (e) {
                    if (!$(e.trigger).data("old-text-value")) {
                        $(e.trigger).data("old-text-value", $(e.trigger).html());
                    }

                    $(e.trigger).text($(e.trigger).data("copy-text"));

                    window.setTimeout(function () {
                        $(e.trigger).html($(e.trigger).data("old-text-value"));
                    }, 1000);
                });

                if (typeof $.fn.datepicker === "function") {
                  $modal.find('.js-time-taken').datepicker({
                    format: "yyyy-mm-dd",
                    language: "ru",
                    autoclose: true,
                    todayHighlight: true
                  });
                }
              }
            });
          });
        },

        // Підтвердження вибраної операції в меню блоку
        ConfirmOperation: function (Type, Block) {

          Block.find('.la-block-menu__operations').hide();
          Block.find('.la-block-menu__confirm').show();

          switch (Type) {

            // Змінити тип блоку
          case 'ChangeType':

            Block.find('.la-block-menu__button--ok').off().on('click', function (event) {
              event.preventDefault();
              Block.find('.la-block-content').hide().empty();
              Block.find('.la-block-menu').hide();
              Block.find('.la-block-menu__confirm').hide();
              Block.find('.la-block-menu__operations').show();
              Block.find('.la-block-categories').show();
              Block.addClass('la-block--empty').removeData('type');
            });

            break;

            // Очистити блок
          case 'RemoveBlock':

            Block.find('.la-block-menu__button--ok').off().on('click', function (event) {
              event.preventDefault();
              Block.find('.la-block-content').hide().empty();
              Block.css('background-color', 'transparent');
              Block.find('.la-block-menu').hide();
              Block.find('.la-block-menu__confirm').hide();
              Block.find('.la-block-plus').show();
              Block.addClass('la-block--empty').removeData('type');
              if ($(this).closest('.grid-block:not(.lb-col-sm-12)')) {
                $(this).closest('.lb-row').prev().remove();
                $(this).closest('.lb-row').next().remove();
              }
              // Article.SaveContent($(this).closest('.la-section')); vsv
              $('.js-mobile-header-save-btn').fadeIn();
              $('.js-save-btn').fadeIn();
              $('.js-mobile-header-saved').hide();
              $('.js-mobile-header-unsaved').addClass('showed').fadeIn();
            });

            break;
          }
        }
      };


      // Ініціалізація редактора
      Article.Init($(this));
      $(this).data('Article', Article);

      if ($(this).attr('data-template-content-url')) {
        $(this).siblings('.lb-container').addClass('has-template');
        var templateContentUrl = $(this).attr('data-template-content-url'),
            id = $(this).attr('id'),
            textarea = $(this);
        $.ajax({
          url: templateContentUrl,
          dataType: 'jsonp',
          method: 'GET',
          success: function (data) {
            var templateGroup = data.groups,
                html = '';
                html += '<div class="templateModal modal fade" id="templateModal'+id+'" tabindex="-1" role="dialog" aria-labelledby="templateModalLabel'+id+'">';
                html += '<div class="modal-dialog" role="document">';
                html += '<div class="modal-content">';
                html += '<div class="modal-header">';
                html += '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hclassden="true" class="icon-close-white"></span></button>';
                html += '<h4 class="modal-title" id="templateModalLabel'+id+'">Выбор шаблона контента</h4>';
                html += '</div>';
                html += '<div class="modal-body">';
                html += '<ul class="template-filter">';
                html += '<li class="all active">Все</li>';
                html += '<li class="personal">Личные</li>';
                html += '<li class="system">Системные</li>';
                html += '</ul>';
            for (group in templateGroup) {
              if (templateGroup[group].templates) {
                html += '<div class="row">';
                html += '<div class="col-sm-12">';
                html += '<h2 class="title-text">';
                if (templateGroup[group].name ) {
                  html += templateGroup[group].name;
                } else {
                  html += 'Без групы';
                }
                html += ' (' + Object.keys(templateGroup[group].templates).length + ')';
                html += '</h2>';
                html += '</div>';
              
                for (templates in templateGroup[group].templates) {
                  html += '<div class="col-sm-3 template-wrp">';
                  var hasPhoto = templateGroup[group].templates[templates].photo_file ? ' has-photo' : ' no-photo';
                  html += '<div class="template'+hasPhoto+'" data-company_id="'+templateGroup[group].templates[templates].company_id+'" data-group_id="'+templateGroup[group].templates[templates].group_id+'" data-id="'+templateGroup[group].templates[templates].id+'">';
                  html += '<div class="template-name">';
                  html += templateGroup[group].templates[templates].name;
                  html += '</div>';
                  if (templateGroup[group].templates[templates].photo_file) {
                    html += '<div class="template-photo">';
                    html += '<img src="'+templateGroup[group].templates[templates].photo_file+'"/>';
                    html += '</div>';
                  }
                  html += '<div class="template-btns">';
                  html += '<a class="insert-template"><i class="material-icons ic_file_download"></i></a>'
                  if (templateGroup[group].templates[templates].example_url) {
                    html += '<a class="demo-template" href="'+templateGroup[group].templates[templates].example_url+'" target="_blank"><i class="material-icons ic_open_in_new"></i></a>'
                  }
                  html += '</div>';
                  var companyText = templateGroup[group].templates[templates].company_id == 0 ? 'Системный' : 'Личный';
                  html += '<div class="template-company">';
                  html += companyText;
                  html += '</div>';
                  html += '</div>';
                  html += '</div>';
                }
                html += '</div>';
              }
            }
            html += '</div>';
            html += '<div class="modal-footer">';
            html += '<div class="row">';
            html += '<div class="col-sm-12">';
            html += '<button type="button" class="btn btn-warning" data-dismiss="modal">Отмена</button>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            $('body').append(html);
            $('#templateModal'+id).on('show.bs.modal', function (e) {
              $(this).find('.modal-body').css({
                'max-height': ($(this).innerHeight() - $(this).innerHeight()*0.1) - 125
              });
            });
            $('.template-filter li').on('click', function () {
              $(this).parent().find('.active').removeClass('active');
              $(this).addClass('active');
              if ($(this).hasClass('all')) {
                $(this).closest('.modal-body').find('.template').parent().show();
              } else if ($(this).hasClass('personal')) {
                $(this).closest('.modal-body').find('.template[data-company_id="0"]').parent().hide();
                $(this).closest('.modal-body').find('.template:not([data-company_id="0"])').parent().show();
              } else if ($(this).hasClass('system')) {
                $(this).closest('.modal-body').find('.template:not([data-company_id="0"])').parent().hide();
                $(this).closest('.modal-body').find('.template[data-company_id="0"]').parent().show();
              }
            });
            $('#templateModal'+id+' .insert-template').on('click', function (e) {
              e.preventDefault();
              var tempId = $(this).closest('.template').attr('data-id');
              $.ajax({
                url: templateContentUrl,
                data: {
                  act: 'get',
                  template_id: tempId
                },
                dataType: 'jsonp',
                method: 'POST',
                success: function (data) {
                  if (textarea.siblings('.lb-container').hasClass('has-content')) {
                    confirm('Станица не пуста, заменить контент на контент шаблона?');
                  }
                  console.log(data);
                  textarea.siblings('.lb-container').find('.la-container-content').html(data.content);
                  $('#templateModal'+id).modal('hide');
                  textarea.closest('form').find('[type="submit"]').trigger('click');
                }
              });
            });
          }
        });
      } else {
        $('body').addClass('no-template');
      }


    }).hide();

    // Повернути textarea
    return this;
  };

})(jQuery);

// Обробити контент перед відправкою (збереженням)
jQuery(function ($) {
  $('textarea').first().closest('form').submit(function () {
    $('textarea').each(function() {
      if ($(this).data('Article')) {
        var Article = $(this).data('Article');
        Article.SaveContent();
      }
    });
    return true;
  });
});

function randomString(length) {
  var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz".split("");
  
  if (! length) {
  length = Math.floor(Math.random() * chars.length);
  }
  
  var str = "";
  for (var i = 0; i < length; i++) {
  str += chars[Math.floor(Math.random() * chars.length)];
  }
  return str;
  }
  